<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Test - Account Dropdown Multi-Select</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #f57315;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            border: 1px solid #f57315;
            padding: 20px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #111;
            border-left: 3px solid #f57315;
            font-size: 12px;
        }
        
        .status-ok { border-left-color: #00ff00; color: #00ff00; }
        .status-error { border-left-color: #ff0000; color: #ff0000; }
        .status-info { border-left-color: #f57315; color: #f57315; }
        .status-warning { border-left-color: #ffff00; color: #ffff00; }
        
        button {
            background: #000;
            color: #f57315;
            border: 2px solid #f57315;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s ease;
        }
        
        button:hover {
            background: #f57315;
            color: #000;
        }
        
        /* Moosh mode overrides */
        body.moosh-mode {
            color: #69fd97;
        }
        
        body.moosh-mode .test-container,
        body.moosh-mode .test-section {
            border-color: #69fd97;
        }
        
        body.moosh-mode button {
            color: #69fd97;
            border-color: #69fd97;
        }
        
        body.moosh-mode button:hover {
            background: #69fd97;
            color: #000;
        }
        
        .dashboard-preview {
            background: #111;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #333;
            min-height: 100px;
        }
        
        .account-info {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #444;
            font-size: 11px;
        }
        
        .active-accounts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .active-account-badge {
            background: rgba(245, 115, 21, 0.1);
            border: 1px solid #f57315;
            padding: 5px 10px;
            font-size: 10px;
        }
        
        body.moosh-mode .active-account-badge {
            background: rgba(105, 253, 151, 0.1);
            border-color: #69fd97;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>[==] ACCOUNT DROPDOWN TEST [==]</h1>
            <p>Testing Multi-Account Selection (Up to 8 Accounts)</p>
        </div>
        
        <div class="test-section">
            <h2>[>] Test Controls</h2>
            <button onclick="toggleTheme()">Toggle Theme (Original/Moosh)</button>
            <button onclick="createTestAccounts()">Create Test Accounts</button>
            <button onclick="checkDropdownState()">Check Dropdown State</button>
            <button onclick="testMultiSelect()">Test Multi-Select</button>
            <button onclick="testMaxAccounts()">Test Max 8 Accounts</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div class="test-section">
            <h2>[>] Current Status</h2>
            <div id="theme-status">Theme: Original (Orange)</div>
            <div id="active-status">Active Accounts: Not checked</div>
            <div id="dropdown-status">Dropdown Text: Not checked</div>
            
            <div class="active-accounts">
                <h3>Active Accounts:</h3>
                <div id="active-accounts-list">No accounts loaded</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>[>] Dashboard Preview</h2>
            <div id="dashboard-preview" class="dashboard-preview">
                <p>Dashboard will load here...</p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>[>] Test Results</h2>
            <div id="test-results"></div>
        </div>
    </div>
    
    <!-- Load MOOSH Wallet -->
    <script src="/public/js/moosh-wallet.js"></script>
    
    <script>
        let app = null;
        let accountSwitcher = null;
        
        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            try {
                app = new MOOSHWallet();
                
                // Create initial test account if none exist
                const accounts = app.state.get('accounts') || [];
                if (accounts.length === 0) {
                    createTestAccounts();
                }
                
                logResult('App initialized', 'ok');
                
                // Navigate to dashboard
                setTimeout(() => {
                    app.router.navigate('dashboard');
                    logResult('Dashboard loaded', 'ok');
                    
                    // Find AccountSwitcher instance
                    setTimeout(() => {
                        findAccountSwitcher();
                        updateStatus();
                    }, 500);
                }, 500);
                
            } catch (error) {
                logResult('Failed to initialize: ' + error.message, 'error');
            }
        });
        
        function logResult(message, status = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result status-${status}`;
            const timestamp = new Date().toLocaleTimeString();
            const indicator = status === 'ok' ? '[OK]' : status === 'error' ? '[X]' : status === 'warning' ? '[!!]' : '[>]';
            resultDiv.textContent = `${timestamp} ${indicator} ${message}`;
            resultsDiv.appendChild(resultDiv);
            console.log(`${indicator} ${message}`);
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            logResult('Results cleared', 'info');
        }
        
        function toggleTheme() {
            const isMooshMode = document.body.classList.contains('moosh-mode');
            if (isMooshMode) {
                document.body.classList.remove('moosh-mode');
                localStorage.setItem('mooshTheme', 'original');
            } else {
                document.body.classList.add('moosh-mode');
                localStorage.setItem('mooshTheme', 'moosh');
            }
            
            updateThemeStatus();
            logResult('Theme toggled', 'ok');
            
            // Update AccountSwitcher
            if (accountSwitcher) {
                accountSwitcher.update();
            }
        }
        
        function updateThemeStatus() {
            const isMooshMode = document.body.classList.contains('moosh-mode');
            const status = document.getElementById('theme-status');
            status.textContent = `Theme: ${isMooshMode ? 'Moosh (Green)' : 'Original (Orange)'}`;
            status.style.color = isMooshMode ? '#69fd97' : '#f57315';
        }
        
        function createTestAccounts() {
            if (!app) {
                logResult('App not initialized', 'error');
                return;
            }
            
            const testAccounts = [];
            for (let i = 1; i <= 10; i++) {
                testAccounts.push({
                    id: `test-account-${i}`,
                    name: `Test Account ${i}`,
                    addresses: { 
                        bitcoin: `bc1qtest${i}...`,
                        segwit: `3test${i}...`,
                        taproot: `tb1ptest${i}...`
                    },
                    type: i % 3 === 0 ? 'imported' : 'generated',
                    balance: (Math.random() * 0.5).toFixed(8),
                    createdAt: Date.now() - (i * 86400000)
                });
            }
            
            app.state.set('accounts', testAccounts);
            app.state.set('currentAccountId', testAccounts[0].id);
            
            logResult(`Created ${testAccounts.length} test accounts`, 'ok');
            
            // Refresh AccountSwitcher
            if (accountSwitcher) {
                accountSwitcher.update();
            }
            
            updateStatus();
        }
        
        function findAccountSwitcher() {
            // Find the AccountSwitcher instance in the dashboard
            const dashboardElement = document.querySelector('.dashboard-container');
            if (!dashboardElement) {
                logResult('Dashboard container not found', 'error');
                return;
            }
            
            // Look for the account switcher element
            const switcherElement = document.querySelector('.account-switcher');
            if (switcherElement) {
                logResult('AccountSwitcher element found', 'ok');
                
                // Try to access the instance through the app's dashboard
                if (app.dashboard && app.dashboard.accountSwitcher) {
                    accountSwitcher = app.dashboard.accountSwitcher;
                    logResult('AccountSwitcher instance accessed', 'ok');
                } else {
                    logResult('AccountSwitcher instance not accessible', 'warning');
                }
            } else {
                logResult('AccountSwitcher element not found', 'error');
            }
        }
        
        function checkDropdownState() {
            if (!accountSwitcher) {
                findAccountSwitcher();
                if (!accountSwitcher) {
                    logResult('AccountSwitcher not available', 'error');
                    return;
                }
            }
            
            const activeCount = accountSwitcher.activeAccountIds.length;
            logResult(`Active accounts: ${activeCount}`, 'info');
            
            const triggerButton = document.querySelector('.account-switcher-trigger');
            if (triggerButton) {
                const buttonText = triggerButton.textContent.trim();
                logResult(`Dropdown text: "${buttonText}"`, 'info');
                
                // Check if it shows correct format
                if (activeCount === 0) {
                    if (buttonText.includes('No active accounts')) {
                        logResult('Correct: Shows "No active accounts"', 'ok');
                    } else {
                        logResult('Incorrect: Should show "No active accounts"', 'error');
                    }
                } else if (activeCount === 1) {
                    if (buttonText.includes('Test Account')) {
                        logResult('Correct: Shows single account name', 'ok');
                    } else {
                        logResult('Incorrect: Should show account name', 'error');
                    }
                } else {
                    if (buttonText.includes(`${activeCount} accounts connected`)) {
                        logResult('Correct: Shows multi-account format', 'ok');
                    } else {
                        logResult(`Incorrect: Should show "${activeCount} accounts connected"`, 'error');
                    }
                }
            } else {
                logResult('Trigger button not found', 'error');
            }
            
            updateStatus();
        }
        
        function testMultiSelect() {
            if (!accountSwitcher) {
                logResult('AccountSwitcher not available', 'error');
                return;
            }
            
            logResult('Testing multi-select functionality...', 'info');
            
            const accounts = app.state.getAccounts();
            if (accounts.length < 3) {
                logResult('Not enough accounts for multi-select test', 'error');
                return;
            }
            
            // Clear active accounts first
            accountSwitcher.activeAccountIds = [accounts[0].id];
            localStorage.setItem('mooshActiveAccounts', JSON.stringify(accountSwitcher.activeAccountIds));
            accountSwitcher.update();
            
            logResult('Reset to 1 active account', 'info');
            
            // Add more accounts
            setTimeout(() => {
                accountSwitcher.toggleAccountActive(accounts[1].id);
                logResult('Added second account', 'info');
                
                setTimeout(() => {
                    accountSwitcher.toggleAccountActive(accounts[2].id);
                    logResult('Added third account', 'info');
                    
                    // Check if display updated
                    const triggerButton = document.querySelector('.account-switcher-trigger');
                    if (triggerButton && triggerButton.textContent.includes('3 accounts connected')) {
                        logResult('Multi-account display working correctly', 'ok');
                    } else {
                        logResult('Multi-account display not updating', 'error');
                    }
                    
                    updateStatus();
                }, 500);
            }, 500);
        }
        
        function testMaxAccounts() {
            if (!accountSwitcher) {
                logResult('AccountSwitcher not available', 'error');
                return;
            }
            
            logResult('Testing max 8 accounts limit...', 'info');
            
            const accounts = app.state.getAccounts();
            if (accounts.length < 9) {
                logResult('Need at least 9 accounts for max test', 'error');
                return;
            }
            
            // Try to activate 9 accounts
            accountSwitcher.activeAccountIds = [];
            for (let i = 0; i < 9; i++) {
                if (i < 8) {
                    accountSwitcher.activeAccountIds.push(accounts[i].id);
                    logResult(`Added account ${i + 1}`, 'info');
                } else {
                    // This should fail
                    const lengthBefore = accountSwitcher.activeAccountIds.length;
                    accountSwitcher.toggleAccountActive(accounts[i].id);
                    const lengthAfter = accountSwitcher.activeAccountIds.length;
                    
                    if (lengthAfter === lengthBefore) {
                        logResult('Correctly prevented adding 9th account', 'ok');
                    } else {
                        logResult('ERROR: Allowed more than 8 accounts', 'error');
                    }
                }
            }
            
            localStorage.setItem('mooshActiveAccounts', JSON.stringify(accountSwitcher.activeAccountIds));
            accountSwitcher.update();
            
            // Check display
            const triggerButton = document.querySelector('.account-switcher-trigger');
            if (triggerButton && triggerButton.textContent.includes('8 accounts connected')) {
                logResult('Max accounts display correct', 'ok');
            }
            
            updateStatus();
        }
        
        function updateStatus() {
            // Update active accounts display
            if (accountSwitcher) {
                const activeCount = accountSwitcher.activeAccountIds.length;
                document.getElementById('active-status').textContent = `Active Accounts: ${activeCount}`;
                
                const accounts = app.state.getAccounts();
                const activeAccountsList = document.getElementById('active-accounts-list');
                activeAccountsList.innerHTML = '';
                
                accountSwitcher.activeAccountIds.forEach(id => {
                    const account = accounts.find(a => a.id === id);
                    if (account) {
                        const badge = document.createElement('div');
                        badge.className = 'active-account-badge';
                        badge.textContent = account.name;
                        activeAccountsList.appendChild(badge);
                    }
                });
                
                if (activeCount === 0) {
                    activeAccountsList.innerHTML = '<span style="color: #888;">No active accounts</span>';
                }
            }
            
            // Update dropdown text display
            const triggerButton = document.querySelector('.account-switcher-trigger');
            if (triggerButton) {
                const buttonText = triggerButton.textContent.trim();
                document.getElementById('dropdown-status').textContent = `Dropdown Text: "${buttonText}"`;
            }
            
            updateThemeStatus();
        }
        
        // Initial log
        logResult('Account dropdown test initialized', 'ok');
    </script>
</body>
</html>