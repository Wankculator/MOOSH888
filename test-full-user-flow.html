<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MOOSH Wallet - Full User Flow Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-section {
            background: #111;
            border: 2px solid #0f0;
            padding: 20px;
            border-radius: 0;
        }
        h1, h2 {
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
            margin: 0 0 20px 0;
        }
        h1 {
            text-align: center;
            font-size: 32px;
        }
        h2 {
            font-size: 20px;
            border-bottom: 1px solid #0f0;
            padding-bottom: 10px;
        }
        button {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 20px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.3s;
        }
        button:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 20px #0f0;
        }
        .result-box {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success {
            border-color: #0f0;
            color: #0f0;
        }
        .error {
            border-color: #f00;
            color: #f00;
        }
        .info {
            border-color: #00f;
            color: #00f;
        }
        .wallet-data {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .label {
            color: #999;
            text-align: right;
        }
        .value {
            color: #0f0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #0f0;
            margin: 20px 0;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: #111;
            border: 1px solid #333;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 1px solid #333;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .step.active {
            background: #0f0;
            color: #000;
            border-color: #0f0;
        }
        .step.completed {
            border-color: #0f0;
            color: #0f0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            transition: all 0.3s;
        }
        .test-card:hover {
            border-color: #0f0;
        }
    </style>
</head>
<body>
    <h1>üß™ MOOSH WALLET - FULL USER FLOW TEST</h1>
    
    <div class="step-indicator">
        <div class="step" id="step1">1. Generate Wallet</div>
        <div class="step" id="step2">2. Store Data</div>
        <div class="step" id="step3">3. Verify Details</div>
        <div class="step" id="step4">4. Test Import</div>
        <div class="step" id="step5">5. Validate Match</div>
    </div>

    <div class="test-container">
        <div class="test-section">
            <h2>üîß Test Controls</h2>
            
            <button onclick="startFullTest()">üöÄ START FULL TEST</button>
            <button onclick="generateNewWallet()">1Ô∏è‚É£ Generate Wallet</button>
            <button onclick="checkStoredData()">2Ô∏è‚É£ Check Stored Data</button>
            <button onclick="simulateDetailsPage()">3Ô∏è‚É£ Simulate Details Page</button>
            <button onclick="testImport()">4Ô∏è‚É£ Test Import</button>
            <button onclick="compareAllData()">5Ô∏è‚É£ Compare All Data</button>
            <button onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            
            <div id="testStatus" class="result-box info" style="margin-top: 20px;">
                Ready to start testing...
            </div>
        </div>
        
        <div class="test-section">
            <h2>üìä Current Wallet Data</h2>
            <div id="currentWalletData" class="result-box">
                No wallet data yet...
            </div>
        </div>
    </div>

    <div class="test-grid">
        <div class="test-card">
            <h2>1Ô∏è‚É£ Generated Wallet</h2>
            <div id="generatedData" class="result-box">
                Not generated yet...
            </div>
        </div>
        
        <div class="test-card">
            <h2>2Ô∏è‚É£ Stored in LocalStorage</h2>
            <div id="storedData" class="result-box">
                Not checked yet...
            </div>
        </div>
        
        <div class="test-card">
            <h2>3Ô∏è‚É£ Details Page Display</h2>
            <div id="detailsData" class="result-box">
                Not checked yet...
            </div>
        </div>
        
        <div class="test-card">
            <h2>4Ô∏è‚É£ Import Result</h2>
            <div id="importData" class="result-box">
                Not tested yet...
            </div>
        </div>
    </div>

    <div class="test-section" style="margin-top: 20px;">
        <h2>‚úÖ Test Results</h2>
        <div id="testResults" class="result-box">
            No tests run yet...
        </div>
    </div>

    <script>
        let testWallet = null;
        let importedWallet = null;
        let currentStep = 0;

        function updateStep(step) {
            document.querySelectorAll('.step').forEach((el, idx) => {
                if (idx < step) el.classList.add('completed');
                else el.classList.remove('completed');
                
                if (idx === step - 1) el.classList.add('active');
                else el.classList.remove('active');
            });
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('testStatus');
            status.textContent = message;
            status.className = 'result-box ' + type;
        }

        function updateResults(results) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = results;
        }

        async function startFullTest() {
            updateStatus('Starting full test sequence...', 'info');
            
            // Run all tests in sequence
            await generateNewWallet();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await checkStoredData();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await simulateDetailsPage();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testImport();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await compareAllData();
        }

        async function generateNewWallet() {
            updateStep(1);
            updateStatus('Generating new wallet...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/spark/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strength: 256 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    testWallet = data.data;
                    
                    // Display generated data
                    document.getElementById('generatedData').innerHTML = formatWalletData(testWallet);
                    document.getElementById('currentWalletData').innerHTML = formatWalletData(testWallet);
                    
                    // Store in localStorage as the UI would
                    localStorage.setItem('generatedSeed', JSON.stringify(testWallet.mnemonic.split(' ')));
                    localStorage.setItem('sparkWallet', JSON.stringify(testWallet));
                    localStorage.setItem('currentWallet', JSON.stringify({
                        mnemonic: testWallet.mnemonic,
                        bitcoinAddress: testWallet.addresses.bitcoin,
                        sparkAddress: testWallet.addresses.spark,
                        privateKeys: testWallet.privateKeys,
                        isInitialized: true
                    }));
                    
                    updateStatus('‚úÖ Wallet generated successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                updateStatus('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function checkStoredData() {
            updateStep(2);
            updateStatus('Checking stored data...', 'info');
            
            const stored = {
                generatedSeed: JSON.parse(localStorage.getItem('generatedSeed') || '[]'),
                sparkWallet: JSON.parse(localStorage.getItem('sparkWallet') || '{}'),
                currentWallet: JSON.parse(localStorage.getItem('currentWallet') || '{}')
            };
            
            document.getElementById('storedData').innerHTML = `
Seed Words: ${stored.generatedSeed.length}
Spark Address: ${stored.sparkWallet.addresses?.spark || 'Not found'}
Bitcoin Address: ${stored.sparkWallet.addresses?.bitcoin || 'Not found'}
Private Key (hex): ${stored.sparkWallet.privateKeys?.hex?.substring(0, 32)}...
Private Key (wif): ${stored.sparkWallet.privateKeys?.wif?.substring(0, 20)}...
            `;
            
            updateStatus('‚úÖ Stored data retrieved', 'success');
        }

        async function simulateDetailsPage() {
            updateStep(3);
            updateStatus('Simulating wallet details page...', 'info');
            
            // This simulates what the WalletDetailsPage would show
            const sparkWallet = JSON.parse(localStorage.getItem('sparkWallet') || '{}');
            const currentWallet = JSON.parse(localStorage.getItem('currentWallet') || '{}');
            
            const detailsDisplay = {
                spark: sparkWallet.addresses?.spark || currentWallet.sparkAddress || 'Not available',
                bitcoin: sparkWallet.addresses?.bitcoin || currentWallet.bitcoinAddress || 'Not available',
                privateKeyHex: sparkWallet.privateKeys?.hex || currentWallet.privateKeys?.hex || 'Not available',
                privateKeyWif: sparkWallet.privateKeys?.wif || currentWallet.privateKeys?.wif || 'Not available'
            };
            
            document.getElementById('detailsData').innerHTML = `
Spark: ${detailsDisplay.spark}
Bitcoin: ${detailsDisplay.bitcoin}
Private (hex): ${detailsDisplay.privateKeyHex.substring(0, 32)}...
Private (wif): ${detailsDisplay.privateKeyWif.substring(0, 20)}...
            `;
            
            updateStatus('‚úÖ Details page data simulated', 'success');
        }

        async function testImport() {
            updateStep(4);
            updateStatus('Testing wallet import...', 'info');
            
            if (!testWallet) {
                updateStatus('‚ùå No wallet to import. Generate one first.', 'error');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3001/api/spark/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mnemonic: testWallet.mnemonic })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    importedWallet = data.data;
                    document.getElementById('importData').innerHTML = formatWalletData(importedWallet);
                    updateStatus('‚úÖ Wallet imported successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Import failed');
                }
            } catch (error) {
                updateStatus('‚ùå Import error: ' + error.message, 'error');
            }
        }

        async function compareAllData() {
            updateStep(5);
            updateStatus('Comparing all wallet data...', 'info');
            
            if (!testWallet || !importedWallet) {
                updateStatus('‚ùå Need both generated and imported wallets to compare', 'error');
                return;
            }
            
            const stored = JSON.parse(localStorage.getItem('sparkWallet') || '{}');
            
            const results = [];
            
            // Check seed phrase
            const seedMatch = testWallet.mnemonic === importedWallet.mnemonic;
            results.push(`Seed Phrase Match: ${seedMatch ? '‚úÖ' : '‚ùå'}`);
            
            // Check Spark address
            const sparkMatch = testWallet.addresses.spark === importedWallet.addresses.spark && 
                             testWallet.addresses.spark === stored.addresses?.spark;
            results.push(`Spark Address Match: ${sparkMatch ? '‚úÖ' : '‚ùå'}`);
            results.push(`  Generated: ${testWallet.addresses.spark}`);
            results.push(`  Imported:  ${importedWallet.addresses.spark}`);
            results.push(`  Stored:    ${stored.addresses?.spark}`);
            
            // Check Bitcoin address
            const btcMatch = testWallet.addresses.bitcoin === importedWallet.addresses.bitcoin;
            results.push(`\nBitcoin Address Match: ${btcMatch ? '‚úÖ' : '‚ùå'}`);
            
            // Check private keys
            const privKeyMatch = testWallet.privateKeys.hex === importedWallet.privateKeys.hex;
            results.push(`Private Key Match: ${privKeyMatch ? '‚úÖ' : '‚ùå'}`);
            
            // Overall result
            const allMatch = seedMatch && sparkMatch && btcMatch && privKeyMatch;
            results.push(`\n${allMatch ? '‚úÖ ALL TESTS PASSED!' : '‚ùå SOME TESTS FAILED!'}`);
            
            updateResults(results.join('\n'));
            updateStatus(allMatch ? '‚úÖ All data matches correctly!' : '‚ùå Data mismatch detected!', allMatch ? 'success' : 'error');
        }

        function formatWalletData(wallet) {
            if (!wallet) return 'No wallet data';
            
            return `Seed: ${wallet.mnemonic}
Words: ${wallet.mnemonic.split(' ').length}
Spark: ${wallet.addresses?.spark || 'N/A'}
Bitcoin: ${wallet.addresses?.bitcoin || 'N/A'}
Private (hex): ${wallet.privateKeys?.hex?.substring(0, 32)}...
Private (wif): ${wallet.privateKeys?.wif?.substring(0, 20)}...
Source: ${wallet.source || 'unknown'}`;
        }

        function clearAllData() {
            if (confirm('Clear all wallet data from localStorage?')) {
                localStorage.removeItem('generatedSeed');
                localStorage.removeItem('sparkWallet');
                localStorage.removeItem('currentWallet');
                localStorage.removeItem('importedSeed');
                
                testWallet = null;
                importedWallet = null;
                
                document.querySelectorAll('.result-box').forEach(el => {
                    if (el.id !== 'testStatus') {
                        el.textContent = 'Cleared...';
                    }
                });
                
                updateStatus('‚úÖ All data cleared', 'success');
                updateStep(0);
            }
        }

        // Auto-check on load
        window.onload = () => {
            const stored = localStorage.getItem('sparkWallet');
            if (stored) {
                updateStatus('Found existing wallet data. You can test with it or generate new.', 'info');
                checkStoredData();
            }
        };
    </script>
</body>
</html>