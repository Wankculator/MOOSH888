<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Ordinals Performance</title>
    <style>
        body {
            background: #000;
            color: #69fd97;
            font-family: monospace;
            padding: 20px;
            line-height: 1.6;
        }
        button {
            background: #69fd97;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
        button:hover {
            opacity: 0.8;
        }
        .log {
            background: #111;
            border: 1px solid #69fd97;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #69fd97; }
        .error { color: #ff4444; }
        .info { color: #4444ff; }
    </style>
</head>
<body>
    <h1>MOOSH Wallet - Ordinals Performance Test</h1>
    
    <div>
        <button onclick="testCachePreload()">Test Cache Preload</button>
        <button onclick="testQuickOpen()">Test Quick Open</button>
        <button onclick="testProgressiveRendering()">Test Progressive Rendering</button>
        <button onclick="clearCache()">Clear Cache</button>
        <button onclick="measureLoadTime()">Measure Load Time</button>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        const log = (message, type = 'info') => {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        };
        
        window.onerror = (msg, url, line) => {
            log(`Error: ${msg} at line ${line}`, 'error');
        };
        
        const testCachePreload = async () => {
            log('Testing cache preload...');
            const startTime = performance.now();
            
            if (window.app?.pages?.dashboard?.fetchOrdinalsCount) {
                try {
                    const count = await window.app.pages.dashboard.fetchOrdinalsCount();
                    const endTime = performance.now();
                    log(`✓ Preloaded ${count} ordinals in ${(endTime - startTime).toFixed(2)}ms`, 'success');
                    
                    // Test cache hit
                    const cacheStartTime = performance.now();
                    const cachedCount = await window.app.pages.dashboard.fetchOrdinalsCount();
                    const cacheEndTime = performance.now();
                    log(`✓ Cache hit: ${cachedCount} ordinals in ${(cacheEndTime - cacheStartTime).toFixed(2)}ms`, 'success');
                } catch (err) {
                    log(`✗ Preload failed: ${err.message}`, 'error');
                }
            } else {
                log('✗ Dashboard not available', 'error');
            }
        };
        
        const testQuickOpen = () => {
            log('Testing quick open...');
            const startTime = performance.now();
            
            if (window.app?.pages?.dashboard?.openOrdinalsGallery) {
                window.app.pages.dashboard.openOrdinalsGallery();
                const endTime = performance.now();
                log(`✓ Gallery opened in ${(endTime - startTime).toFixed(2)}ms`, 'success');
                
                // Check if data was pre-populated
                setTimeout(() => {
                    if (window.app.ordinalsModal?.inscriptions?.length > 0) {
                        log(`✓ Gallery pre-populated with ${window.app.ordinalsModal.inscriptions.length} inscriptions`, 'success');
                    } else {
                        log('ℹ Gallery loading inscriptions...', 'info');
                    }
                }, 100);
            } else {
                log('✗ Gallery function not available', 'error');
            }
        };
        
        const testProgressiveRendering = () => {
            log('Testing progressive rendering...');
            
            if (window.app?.ordinalsModal) {
                // Simulate large dataset
                const mockInscriptions = Array(100).fill(null).map((_, i) => ({
                    id: `test_${i}`,
                    number: i + 1,
                    content_type: 'image/png',
                    content_length: 1000,
                    timestamp: Date.now() - i * 1000
                }));
                
                window.app.ordinalsModal.inscriptions = mockInscriptions;
                window.app.ordinalsModal.isLoading = false;
                
                const startTime = performance.now();
                window.app.ordinalsModal.updateInscriptionList();
                const endTime = performance.now();
                
                log(`✓ Rendered ${mockInscriptions.length} inscriptions in ${(endTime - startTime).toFixed(2)}ms`, 'success');
            } else {
                log('✗ Ordinals modal not available', 'error');
            }
        };
        
        const clearCache = () => {
            log('Clearing cache...');
            sessionStorage.removeItem('ordinals_cache');
            if (window.app?.pages?.dashboard) {
                window.app.pages.dashboard._ordinalsCache = null;
            }
            window.CURRENT_ORDINALS_DATA = null;
            log('✓ Cache cleared', 'success');
        };
        
        const measureLoadTime = async () => {
            log('Measuring load times...');
            
            // Clear cache first
            clearCache();
            
            // Measure cold load
            const coldStartTime = performance.now();
            if (window.app?.pages?.dashboard?.openOrdinalsGallery) {
                window.app.pages.dashboard.openOrdinalsGallery();
                
                // Wait for load
                const checkLoaded = setInterval(() => {
                    if (window.app.ordinalsModal && !window.app.ordinalsModal.isLoading) {
                        clearInterval(checkLoaded);
                        const coldEndTime = performance.now();
                        const coldLoadTime = coldEndTime - coldStartTime;
                        log(`Cold load: ${coldLoadTime.toFixed(2)}ms`, 'info');
                        
                        // Close modal
                        window.app.ordinalsModal.close();
                        
                        // Measure warm load
                        setTimeout(() => {
                            const warmStartTime = performance.now();
                            window.app.pages.dashboard.openOrdinalsGallery();
                            
                            setTimeout(() => {
                                const warmEndTime = performance.now();
                                const warmLoadTime = warmEndTime - warmStartTime;
                                log(`Warm load: ${warmLoadTime.toFixed(2)}ms`, 'info');
                                
                                const improvement = ((coldLoadTime - warmLoadTime) / coldLoadTime * 100).toFixed(1);
                                log(`✓ Performance improvement: ${improvement}%`, 'success');
                            }, 100);
                        }, 500);
                    }
                }, 100);
            }
        };
        
        // Initial log
        log('Ordinals performance test ready', 'success');
        log('Make sure the wallet is loaded and logged in', 'info');
    </script>
</body>
</html>