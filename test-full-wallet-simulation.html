<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Wallet - Full User Simulation Test</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #f57315;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            border: 2px solid #f57315;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .test-section {
            border: 1px solid #f57315;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #ff8c42;
        }
        
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid transparent;
        }
        
        .test-result.success {
            border-left-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }
        
        .test-result.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        
        .test-result.warning {
            border-left-color: #ff9800;
            background: rgba(255, 152, 0, 0.1);
        }
        
        .test-result.info {
            border-left-color: #2196f3;
            background: rgba(33, 150, 243, 0.1);
        }
        
        .test-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .stat-box {
            border: 1px solid #f57315;
            padding: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .test-controls {
            margin: 20px 0;
            text-align: center;
        }
        
        button {
            background: #f57315;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            font-family: monospace;
            font-size: 14px;
        }
        
        button:hover {
            background: #ff8c42;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #333;
            border: 1px solid #f57315;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #f57315;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .account-preview {
            display: inline-block;
            padding: 5px 10px;
            margin: 2px;
            border: 1px solid;
            border-radius: 3px;
        }
        
        pre {
            background: #111;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß™ MOOSH Wallet - Full User Simulation Test</h1>
            <p>Comprehensive testing of all wallet features and Phase 2 implementations</p>
            <p id="test-time">Test started at: <span></span></p>
        </div>

        <div class="test-controls">
            <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
            <button onclick="runPhase2Tests()">üé® Test Phase 2 Features</button>
            <button onclick="runCoreTests()">üîß Test Core Features</button>
            <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>

        <div class="test-stats">
            <div class="stat-box">
                <div class="stat-value" id="total-tests">0</div>
                <div>Total Tests</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="passed-tests" style="color: #4caf50;">0</div>
                <div>Passed</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="failed-tests" style="color: #f44336;">0</div>
                <div>Failed</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="warning-tests" style="color: #ff9800;">0</div>
                <div>Warnings</div>
            </div>
        </div>

        <div id="test-results"></div>
    </div>

    <script>
        // Test Statistics
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0
        };

        // Test start time
        document.querySelector('#test-time span').textContent = new Date().toLocaleString();

        // Test result logging
        function logTest(category, test, status, message, details = null) {
            testStats.total++;
            
            let statusClass = 'info';
            if (status === 'PASS') {
                statusClass = 'success';
                testStats.passed++;
            } else if (status === 'FAIL') {
                statusClass = 'error';
                testStats.failed++;
            } else if (status === 'WARN') {
                statusClass = 'warning';
                testStats.warnings++;
            }

            const container = document.getElementById('test-results');
            let section = document.querySelector(`[data-category="${category}"]`);
            
            if (!section) {
                section = document.createElement('div');
                section.className = 'test-section';
                section.setAttribute('data-category', category);
                section.innerHTML = `<h3>${category}</h3><div class="test-list"></div>`;
                container.appendChild(section);
            }

            const testList = section.querySelector('.test-list');
            const result = document.createElement('div');
            result.className = `test-result ${statusClass}`;
            result.innerHTML = `
                <strong>[${status}]</strong> ${test}: ${message}
                ${details ? `<pre>${JSON.stringify(details, null, 2)}</pre>` : ''}
            `;
            testList.appendChild(result);

            updateStats();
            updateProgress();
        }

        function updateStats() {
            document.getElementById('total-tests').textContent = testStats.total;
            document.getElementById('passed-tests').textContent = testStats.passed;
            document.getElementById('failed-tests').textContent = testStats.failed;
            document.getElementById('warning-tests').textContent = testStats.warnings;
        }

        function updateProgress() {
            const progress = (testStats.total / 50) * 100; // Assuming ~50 tests
            document.getElementById('progress').style.width = Math.min(progress, 100) + '%';
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            testStats = { total: 0, passed: 0, failed: 0, warnings: 0 };
            updateStats();
            updateProgress();
        }

        // Core Test Functions
        async function testLocalStorage() {
            try {
                const testKey = 'moosh_test_' + Date.now();
                localStorage.setItem(testKey, 'test_value');
                const value = localStorage.getItem(testKey);
                localStorage.removeItem(testKey);
                
                if (value === 'test_value') {
                    logTest('Core Functionality', 'LocalStorage', 'PASS', 'LocalStorage is working correctly');
                } else {
                    logTest('Core Functionality', 'LocalStorage', 'FAIL', 'LocalStorage read/write mismatch');
                }
            } catch (error) {
                logTest('Core Functionality', 'LocalStorage', 'FAIL', 'LocalStorage error: ' + error.message);
            }
        }

        async function testWalletState() {
            try {
                const state = localStorage.getItem('sparkWalletState');
                if (!state) {
                    logTest('Wallet State', 'State Existence', 'WARN', 'No wallet state found in localStorage');
                    return;
                }

                const parsedState = JSON.parse(state);
                logTest('Wallet State', 'State Parse', 'PASS', 'State parsed successfully');

                // Check state structure
                const requiredFields = ['accounts', 'currentAccountIndex'];
                const missingFields = requiredFields.filter(field => !(field in parsedState));
                
                if (missingFields.length === 0) {
                    logTest('Wallet State', 'State Structure', 'PASS', 'All required fields present');
                } else {
                    logTest('Wallet State', 'State Structure', 'FAIL', 'Missing fields: ' + missingFields.join(', '));
                }

                // Check accounts
                if (Array.isArray(parsedState.accounts)) {
                    logTest('Wallet State', 'Accounts Array', 'PASS', `Found ${parsedState.accounts.length} accounts`);
                    
                    // Test each account
                    parsedState.accounts.forEach((account, index) => {
                        testAccountStructure(account, index);
                    });
                } else {
                    logTest('Wallet State', 'Accounts Array', 'FAIL', 'Accounts is not an array');
                }

            } catch (error) {
                logTest('Wallet State', 'State Loading', 'FAIL', 'Error loading state: ' + error.message);
            }
        }

        function testAccountStructure(account, index) {
            const accountFields = ['name', 'encryptedSeed', 'addresses', 'createdAt'];
            const missingFields = accountFields.filter(field => !(field in account));
            
            if (missingFields.length === 0) {
                logTest('Account Structure', `Account ${index}`, 'PASS', `Account "${account.name}" has all required fields`);
            } else {
                logTest('Account Structure', `Account ${index}`, 'FAIL', `Missing fields: ${missingFields.join(', ')}`);
            }

            // Test Phase 2 color feature
            if ('color' in account) {
                if (account.color && account.color.match(/^#[0-9A-Fa-f]{6}$/)) {
                    logTest('Phase 2 - Colors', `Account ${index} Color`, 'PASS', 
                        `Account "${account.name}" has valid color: ${account.color}`,
                        { accountName: account.name, color: account.color });
                } else {
                    logTest('Phase 2 - Colors', `Account ${index} Color`, 'FAIL', 
                        `Invalid color format: ${account.color}`);
                }
            } else {
                logTest('Phase 2 - Colors', `Account ${index} Color`, 'WARN', 
                    `Account "${account.name}" missing color property`);
            }

            // Test addresses
            if (account.addresses) {
                const addressTypes = ['bitcoin', 'spark', 'segwit', 'taproot'];
                addressTypes.forEach(type => {
                    if (account.addresses[type]) {
                        logTest('Address Validation', `${account.name} - ${type}`, 'PASS', 
                            `Has ${type} address: ${account.addresses[type].substring(0, 10)}...`);
                    }
                });
            }
        }

        async function testPhase2Colors() {
            logTest('Phase 2 - Colors', 'Feature Check', 'INFO', 'Starting Phase 2 color system tests...');

            try {
                const state = JSON.parse(localStorage.getItem('sparkWalletState') || '{}');
                const accounts = state.accounts || [];

                // Test 1: Check if all accounts have colors
                const accountsWithColors = accounts.filter(acc => acc.color);
                const accountsWithoutColors = accounts.filter(acc => !acc.color);

                if (accountsWithoutColors.length === 0 && accounts.length > 0) {
                    logTest('Phase 2 - Colors', 'Color Assignment', 'PASS', 
                        `All ${accounts.length} accounts have colors assigned`);
                } else if (accountsWithoutColors.length > 0) {
                    logTest('Phase 2 - Colors', 'Color Assignment', 'WARN', 
                        `${accountsWithoutColors.length} accounts missing colors`,
                        { withoutColors: accountsWithoutColors.map(a => a.name) });
                }

                // Test 2: Check color palette
                const expectedPalette = [
                    '#f57315', '#ff8c42', '#e85d04', '#ffb366',
                    '#dc2f02', '#faa307', '#fb8500', '#ffba08'
                ];

                const usedColors = accounts.map(acc => acc.color).filter(Boolean);
                const validColors = usedColors.filter(color => expectedPalette.includes(color));
                const invalidColors = usedColors.filter(color => !expectedPalette.includes(color));

                if (invalidColors.length === 0) {
                    logTest('Phase 2 - Colors', 'Color Palette', 'PASS', 
                        'All account colors are from the correct palette');
                } else {
                    logTest('Phase 2 - Colors', 'Color Palette', 'FAIL', 
                        `Found ${invalidColors.length} invalid colors`,
                        { invalidColors });
                }

                // Test 3: Color distribution for first 8 accounts
                if (accounts.length >= 8) {
                    const first8Colors = accounts.slice(0, 8).map(acc => acc.color);
                    const uniqueColors = [...new Set(first8Colors)];
                    
                    if (uniqueColors.length === 8) {
                        logTest('Phase 2 - Colors', 'Color Distribution', 'PASS', 
                            'First 8 accounts have unique colors');
                    } else {
                        logTest('Phase 2 - Colors', 'Color Distribution', 'WARN', 
                            `First 8 accounts have ${uniqueColors.length} unique colors (expected 8)`);
                    }
                }

                // Test 4: Display color preview
                if (accounts.length > 0) {
                    const preview = accounts.map(acc => 
                        `<span class="account-preview" style="border-color: ${acc.color}; color: ${acc.color}">
                            ${acc.name}
                        </span>`
                    ).join('');
                    
                    logTest('Phase 2 - Colors', 'Visual Preview', 'INFO', 
                        'Account color preview:<br>' + preview);
                }

            } catch (error) {
                logTest('Phase 2 - Colors', 'Color System', 'FAIL', 
                    'Error testing color system: ' + error.message);
            }
        }

        async function testUIComponents() {
            logTest('UI Components', 'Testing', 'INFO', 'Checking UI component availability...');

            // Test if app is loaded
            if (typeof window.MooshWalletApp !== 'undefined') {
                logTest('UI Components', 'App Instance', 'PASS', 'MooshWalletApp is loaded');
                
                // Test state manager
                if (window.MooshWalletApp.state) {
                    logTest('UI Components', 'State Manager', 'PASS', 'State manager is available');
                    
                    // Test state methods
                    const methods = ['getAccounts', 'getCurrentAccount', 'createAccount', 'updateAccountColor'];
                    methods.forEach(method => {
                        if (typeof window.MooshWalletApp.state[method] === 'function') {
                            logTest('UI Components', `Method: ${method}`, 'PASS', 'Method exists');
                        } else {
                            logTest('UI Components', `Method: ${method}`, 'FAIL', 'Method not found');
                        }
                    });
                }
            } else {
                logTest('UI Components', 'App Instance', 'WARN', 
                    'MooshWalletApp not loaded - open the actual wallet to test UI');
            }
        }

        async function simulateUserActions() {
            logTest('User Simulation', 'Starting', 'INFO', 'Simulating user interactions...');

            try {
                // Simulate color changes
                const state = JSON.parse(localStorage.getItem('sparkWalletState') || '{}');
                if (state.accounts && state.accounts.length > 0) {
                    const testAccount = state.accounts[0];
                    const originalColor = testAccount.color;
                    
                    // Change color
                    testAccount.color = '#ff8c42';
                    state.accounts[0] = testAccount;
                    localStorage.setItem('sparkWalletState', JSON.stringify(state));
                    
                    // Verify change
                    const newState = JSON.parse(localStorage.getItem('sparkWalletState'));
                    if (newState.accounts[0].color === '#ff8c42') {
                        logTest('User Simulation', 'Color Change', 'PASS', 
                            'Successfully simulated color change');
                    } else {
                        logTest('User Simulation', 'Color Change', 'FAIL', 
                            'Color change not persisted');
                    }
                    
                    // Restore original
                    testAccount.color = originalColor;
                    state.accounts[0] = testAccount;
                    localStorage.setItem('sparkWalletState', JSON.stringify(state));
                }
            } catch (error) {
                logTest('User Simulation', 'Simulation Error', 'FAIL', error.message);
            }
        }

        async function testPerformance() {
            logTest('Performance', 'Starting', 'INFO', 'Running performance tests...');

            // Test state loading speed
            const startTime = performance.now();
            const state = localStorage.getItem('sparkWalletState');
            const loadTime = performance.now() - startTime;
            
            if (loadTime < 10) {
                logTest('Performance', 'State Load Time', 'PASS', `Loaded in ${loadTime.toFixed(2)}ms`);
            } else {
                logTest('Performance', 'State Load Time', 'WARN', `Loaded in ${loadTime.toFixed(2)}ms (>10ms)`);
            }

            // Test parse speed
            if (state) {
                const parseStart = performance.now();
                JSON.parse(state);
                const parseTime = performance.now() - parseStart;
                
                if (parseTime < 5) {
                    logTest('Performance', 'State Parse Time', 'PASS', `Parsed in ${parseTime.toFixed(2)}ms`);
                } else {
                    logTest('Performance', 'State Parse Time', 'WARN', `Parsed in ${parseTime.toFixed(2)}ms (>5ms)`);
                }
            }
        }

        async function testEdgeCases() {
            logTest('Edge Cases', 'Starting', 'INFO', 'Testing edge cases...');

            // Test with no accounts
            const state = JSON.parse(localStorage.getItem('sparkWalletState') || '{}');
            if (state.accounts && state.accounts.length === 0) {
                logTest('Edge Cases', 'Empty Accounts', 'PASS', 'Handles empty account list');
            }

            // Test invalid color values
            try {
                const testInvalidColor = (color) => {
                    return color && color.match(/^#[0-9A-Fa-f]{6}$/);
                };

                const invalidColors = ['#fff', 'red', '#gggggg', null, undefined, ''];
                invalidColors.forEach(color => {
                    if (!testInvalidColor(color)) {
                        logTest('Edge Cases', 'Invalid Color Validation', 'PASS', 
                            `Correctly rejects invalid color: ${color}`);
                    }
                });
            } catch (error) {
                logTest('Edge Cases', 'Color Validation', 'FAIL', error.message);
            }
        }

        // Main test runners
        async function runAllTests() {
            clearResults();
            logTest('Test Suite', 'Starting', 'INFO', 'Running all tests...');
            
            await testLocalStorage();
            await testWalletState();
            await testPhase2Colors();
            await testUIComponents();
            await simulateUserActions();
            await testPerformance();
            await testEdgeCases();
            
            logTest('Test Suite', 'Complete', 'INFO', 
                `Test suite completed: ${testStats.passed} passed, ${testStats.failed} failed, ${testStats.warnings} warnings`);
        }

        async function runPhase2Tests() {
            clearResults();
            logTest('Phase 2 Tests', 'Starting', 'INFO', 'Running Phase 2 feature tests...');
            
            await testWalletState();
            await testPhase2Colors();
            await simulateUserActions();
            
            logTest('Phase 2 Tests', 'Complete', 'INFO', 
                `Phase 2 tests completed: ${testStats.passed} passed, ${testStats.failed} failed`);
        }

        async function runCoreTests() {
            clearResults();
            logTest('Core Tests', 'Starting', 'INFO', 'Running core functionality tests...');
            
            await testLocalStorage();
            await testWalletState();
            await testUIComponents();
            await testPerformance();
            await testEdgeCases();
            
            logTest('Core Tests', 'Complete', 'INFO', 
                `Core tests completed: ${testStats.passed} passed, ${testStats.failed} failed`);
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                logTest('System', 'Test Suite Ready', 'INFO', 'Click "Run All Tests" to begin comprehensive testing');
            }, 500);
        });
    </script>
</body>
</html>