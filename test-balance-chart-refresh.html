<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Test - Balance Chart Refresh</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #f57315;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #f57315;
            padding: 20px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #111;
            border-left: 3px solid #f57315;
        }
        
        .status-ok { border-left-color: #00ff00; }
        .status-error { border-left-color: #ff0000; }
        .status-info { border-left-color: #f57315; }
        
        button {
            background: #f57315;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #ff8c42;
        }
        
        #mock-dashboard {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #f57315;
            background: #111;
        }
        
        #balanceChartSection {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            text-align: center;
        }
        
        .chart-placeholder {
            display: inline-block;
            padding: 40px;
            border: 2px dashed #f57315;
            background: #222;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>Balance Chart Refresh Test</h1>
            <p>Testing chart updates after balance refresh</p>
        </div>
        
        <div class="test-section">
            <h2>Test Controls</h2>
            <button onclick="testBalanceRefresh()">Test Balance Refresh</button>
            <button onclick="testChartUpdate()">Test Direct Chart Update</button>
            <button onclick="testErrorCase()">Test Error Case</button>
            <button onclick="testSparkWallet()">Test Spark Wallet (0 Balance)</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div id="mock-dashboard">
            <h3>Mock Dashboard</h3>
            <div>
                <span>BTC Balance: </span>
                <span id="btcBalance">0.00000000 BTC</span>
            </div>
            <div>
                <span>USD Value: </span>
                <span id="btcUsdValue">$0.00</span>
            </div>
            <div id="balanceChartSection">
                <div class="chart-placeholder" id="chart-content">
                    [Chart Placeholder - Balance: 0]
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Test Results</h2>
            <div id="test-results"></div>
        </div>
    </div>
    
    <script>
        // Test utilities
        function logResult(message, status = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result status-${status}`;
            const timestamp = new Date().toLocaleTimeString();
            const indicator = status === 'ok' ? '[OK]' : status === 'error' ? '[X]' : '[>]';
            resultDiv.textContent = `${timestamp} ${indicator} ${message}`;
            resultsDiv.appendChild(resultDiv);
            console.log(`${indicator} ${message}`);
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            logResult('Results cleared', 'info');
        }
        
        // Mock the createBalanceChart function
        function createBalanceChart() {
            const btcText = document.getElementById('btcBalance').textContent;
            const btcValue = parseFloat(btcText) || 0;
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-placeholder';
            chartDiv.id = 'chart-content';
            chartDiv.textContent = `[Chart Updated - Balance: ${btcValue.toFixed(8)} BTC]`;
            chartDiv.style.borderColor = btcValue > 0 ? '#00ff00' : '#f57315';
            
            logResult(`Chart created with balance: ${btcValue.toFixed(8)} BTC`, 'ok');
            return chartDiv;
        }
        
        // Test balance refresh with chart update
        function testBalanceRefresh() {
            logResult('Starting balance refresh test...', 'info');
            
            // Simulate balance update
            const newBalance = Math.random() * 0.1; // Random balance between 0 and 0.1 BTC
            const usdValue = newBalance * 45000; // Assume $45k BTC price
            
            // Update balance displays
            document.getElementById('btcBalance').textContent = `${newBalance.toFixed(8)} BTC`;
            document.getElementById('btcUsdValue').textContent = `$${usdValue.toFixed(2)}`;
            
            logResult(`Balance updated to ${newBalance.toFixed(8)} BTC`, 'ok');
            
            // Simulate chart refresh (as would happen in refreshBalances)
            const chartSection = document.getElementById('balanceChartSection');
            if (chartSection) {
                logResult('Found chart section, refreshing...', 'info');
                
                // Clear existing content
                while (chartSection.firstChild) {
                    chartSection.removeChild(chartSection.firstChild);
                }
                
                // Re-create the chart
                const newChart = createBalanceChart();
                chartSection.appendChild(newChart);
                
                logResult('Chart refresh complete', 'ok');
            } else {
                logResult('Chart section not found!', 'error');
            }
        }
        
        // Test direct chart update
        function testChartUpdate() {
            logResult('Testing direct chart update...', 'info');
            
            const chartSection = document.getElementById('balanceChartSection');
            if (chartSection) {
                // Get current balance
                const btcText = document.getElementById('btcBalance').textContent;
                const currentBalance = parseFloat(btcText) || 0;
                
                logResult(`Current balance: ${currentBalance.toFixed(8)} BTC`, 'info');
                
                // Clear and recreate
                while (chartSection.firstChild) {
                    chartSection.removeChild(chartSection.firstChild);
                }
                
                const newChart = createBalanceChart();
                chartSection.appendChild(newChart);
                
                logResult('Direct chart update complete', 'ok');
            }
        }
        
        // Test error case (should set balance to 0)
        function testErrorCase() {
            logResult('Testing error case...', 'info');
            
            // Simulate error - set balance to 0
            document.getElementById('btcBalance').textContent = '0.00000000 BTC';
            document.getElementById('btcUsdValue').textContent = '$0.00';
            
            logResult('Balance set to 0 due to error', 'error');
            
            // Update chart
            const chartSection = document.getElementById('balanceChartSection');
            if (chartSection) {
                while (chartSection.firstChild) {
                    chartSection.removeChild(chartSection.firstChild);
                }
                
                const newChart = createBalanceChart();
                chartSection.appendChild(newChart);
                
                logResult('Chart updated for error case', 'ok');
            }
        }
        
        // Test Spark wallet case
        function testSparkWallet() {
            logResult('Testing Spark wallet (0 balance)...', 'info');
            
            // Spark wallets show 0 balance
            document.getElementById('btcBalance').textContent = '0.00000000 BTC';
            document.getElementById('btcUsdValue').textContent = '$0.00';
            
            logResult('Spark wallet balance set to 0', 'info');
            
            // Update chart for Spark wallet
            const chartSection = document.getElementById('balanceChartSection');
            if (chartSection) {
                logResult('Refreshing chart for Spark wallet...', 'info');
                
                while (chartSection.firstChild) {
                    chartSection.removeChild(chartSection.firstChild);
                }
                
                const newChart = createBalanceChart();
                chartSection.appendChild(newChart);
                
                logResult('Chart updated for Spark wallet', 'ok');
            }
        }
        
        // Initial log
        logResult('Balance chart refresh test initialized', 'ok');
    </script>
</body>
</html>