<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Wallet - Modal Close Navigation Test</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Test interface styles */
        body {
            margin: 0;
            padding: 0;
            background: #000000;
            color: #69fd97;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .test-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        .test-panel {
            background: #000000;
            border: 2px solid #f57315;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        .test-header {
            border-bottom: 1px solid #333333;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .test-header h1 {
            margin: 0;
            font-size: 20px;
            color: #f57315;
            text-shadow: 0 0 5px #f57315;
        }

        .test-header p {
            margin: 5px 0 0 0;
            color: #666666;
            font-size: 12px;
        }

        .test-button {
            display: block;
            width: 100%;
            background: #000000;
            border: 1px solid #f57315;
            color: #f57315;
            padding: 10px;
            margin: 10px 0;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .test-button:hover {
            background: #f57315;
            color: #000000;
            box-shadow: 0 0 10px #f57315;
        }

        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .test-log {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333333;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding-left: 10px;
            border-left: 3px solid #333333;
        }

        .log-entry.success {
            border-color: #69fd97;
            color: #69fd97;
        }

        .log-entry.error {
            border-color: #ff4444;
            color: #ff4444;
        }

        .log-entry.warning {
            border-color: #f57315;
            color: #f57315;
        }

        .log-entry.info {
            border-color: #666666;
            color: #666666;
        }

        .wallet-frame {
            width: 100%;
            height: 100%;
            border: 2px solid #f57315;
            background: #000000;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
            background: #333333;
        }

        .status-indicator.active {
            background: #69fd97;
            box-shadow: 0 0 5px #69fd97;
        }

        .test-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(245, 115, 21, 0.1);
            border: 1px solid #f57315;
            padding: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #f57315;
        }

        .stat-label {
            font-size: 10px;
            color: #666666;
            text-transform: uppercase;
        }

        @media (max-width: 1024px) {
            .test-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <!-- Test Control Panel -->
        <div class="test-panel">
            <div class="test-header">
                <h1>Modal Close Navigation Test</h1>
                <p>Testing that all modals return to dashboard on close</p>
            </div>

            <div class="test-stats">
                <div class="stat-card">
                    <div class="stat-value" id="modal-count">0</div>
                    <div class="stat-label">Modals Tested</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pass-count">0</div>
                    <div class="stat-label">Tests Passed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="fail-count">0</div>
                    <div class="stat-label">Tests Failed</div>
                </div>
            </div>

            <button class="test-button" onclick="testAllModals()">
                üöÄ Run All Modal Tests
            </button>

            <button class="test-button" onclick="testAccountsModal()">
                üë• Test Accounts Modal
            </button>

            <button class="test-button" onclick="testSendModal()">
                üí∏ Test Send Modal
            </button>

            <button class="test-button" onclick="testReceiveModal()">
                üì• Test Receive Modal
            </button>

            <button class="test-button" onclick="testSettingsModal()">
                ‚öôÔ∏è Test Settings Modal
            </button>

            <button class="test-button" onclick="clearLog()">
                üóëÔ∏è Clear Log
            </button>

            <div class="test-log" id="test-log"></div>
        </div>

        <!-- Wallet Preview Panel -->
        <div class="test-panel">
            <div class="test-header">
                <h1>Wallet Instance</h1>
                <p>Current Page: <span id="current-page" style="color: #f57315">Loading...</span></p>
            </div>
            <iframe src="/index.html" class="wallet-frame" id="wallet-frame"></iframe>
        </div>
    </div>

    <script>
        // Test state
        let stats = {
            modalCount: 0,
            passCount: 0,
            failCount: 0
        };

        // Logging utility
        function log(message, type = 'info') {
            const logContainer = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Clear log
        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
            stats = { modalCount: 0, passCount: 0, failCount: 0 };
            updateStats();
            log('Log cleared', 'info');
        }

        // Update statistics
        function updateStats() {
            document.getElementById('modal-count').textContent = stats.modalCount;
            document.getElementById('pass-count').textContent = stats.passCount;
            document.getElementById('fail-count').textContent = stats.failCount;
        }

        // Wait for wallet to load
        async function waitForWallet() {
            const frame = document.getElementById('wallet-frame');
            
            return new Promise((resolve) => {
                let attempts = 0;
                const checkInterval = setInterval(() => {
                    attempts++;
                    try {
                        const walletWindow = frame.contentWindow;
                        if (walletWindow.MooshWallet && walletWindow.MooshWallet.router) {
                            clearInterval(checkInterval);
                            log('Wallet loaded successfully', 'success');
                            
                            // Monitor page changes
                            startPageMonitoring(walletWindow);
                            
                            resolve(walletWindow);
                        }
                    } catch (e) {
                        // Cross-origin issues, keep trying
                    }
                    
                    if (attempts > 100) { // 10 seconds timeout
                        clearInterval(checkInterval);
                        log('Wallet load timeout', 'error');
                        resolve(null);
                    }
                }, 100);
            });
        }

        // Monitor current page
        function startPageMonitoring(walletWindow) {
            setInterval(() => {
                try {
                    const currentPage = walletWindow.MooshWallet.router.currentPage;
                    document.getElementById('current-page').textContent = currentPage || 'Unknown';
                } catch (e) {
                    document.getElementById('current-page').textContent = 'Error';
                }
            }, 100);
        }

        // Load modal close fix
        async function loadModalCloseFix() {
            const walletWindow = await waitForWallet();
            if (!walletWindow) return false;

            try {
                // Inject the modal close fix script
                const script = walletWindow.document.createElement('script');
                script.src = '/fix-modal-close-navigation.js';
                walletWindow.document.head.appendChild(script);
                
                // Wait for script to load
                await new Promise(resolve => {
                    script.onload = resolve;
                    setTimeout(resolve, 2000); // Timeout after 2 seconds
                });
                
                log('Modal close fix loaded', 'success');
                return true;
            } catch (e) {
                log(`Failed to load modal close fix: ${e.message}`, 'error');
                return false;
            }
        }

        // Test a specific modal
        async function testModal(modalName, buttonSelector) {
            const walletWindow = await waitForWallet();
            if (!walletWindow) {
                log(`Cannot test ${modalName} - wallet not loaded`, 'error');
                return false;
            }

            stats.modalCount++;
            log(`Testing ${modalName}...`, 'info');

            try {
                // Navigate to dashboard first
                walletWindow.MooshWallet.router.navigate('dashboard');
                await new Promise(resolve => setTimeout(resolve, 500));

                // Find and click the button to open modal
                const button = walletWindow.document.querySelector(buttonSelector);
                if (!button) {
                    log(`${modalName} button not found`, 'error');
                    stats.failCount++;
                    updateStats();
                    return false;
                }

                // Click to open modal
                button.click();
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Check if modal opened
                const modal = walletWindow.document.querySelector('.modal-overlay');
                if (!modal) {
                    log(`${modalName} modal did not open`, 'error');
                    stats.failCount++;
                    updateStats();
                    return false;
                }

                log(`${modalName} modal opened`, 'success');

                // Find close button
                let closeButton = modal.querySelector('.modal-close, button[onclick*="close"]');
                
                // If no close button, try clicking the overlay
                if (!closeButton) {
                    log(`No close button found, clicking overlay`, 'warning');
                    modal.click();
                } else {
                    closeButton.click();
                }

                // Wait for modal to close
                await new Promise(resolve => setTimeout(resolve, 500));

                // Check if we're back on dashboard
                const currentPage = walletWindow.MooshWallet.router.currentPage;
                if (currentPage === 'dashboard') {
                    log(`${modalName} successfully returned to dashboard`, 'success');
                    stats.passCount++;
                    updateStats();
                    return true;
                } else {
                    log(`${modalName} failed - current page: ${currentPage}`, 'error');
                    stats.failCount++;
                    updateStats();
                    return false;
                }

            } catch (e) {
                log(`Error testing ${modalName}: ${e.message}`, 'error');
                stats.failCount++;
                updateStats();
                return false;
            }
        }

        // Test all modals
        async function testAllModals() {
            log('Starting comprehensive modal test...', 'info');
            
            // Load the fix first
            const fixLoaded = await loadModalCloseFix();
            if (!fixLoaded) {
                log('Cannot proceed without modal close fix', 'error');
                return;
            }

            // Wait a bit for fix to initialize
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Test each modal
            const modals = [
                { name: 'Accounts', selector: 'button:has-text("Accounts"), button:has-text("+")', altSelector: '[class*="accounts"]' },
                { name: 'Send', selector: 'button:has-text("Send")', altSelector: '[class*="send"]' },
                { name: 'Receive', selector: 'button:has-text("Receive")', altSelector: '[class*="receive"]' },
                { name: 'Settings', selector: 'button:has-text("Settings"), button:has-text("‚öô")', altSelector: '[class*="settings"]' }
            ];

            for (const modal of modals) {
                // Try primary selector first, then alternative
                let selector = await findWorkingSelector(modal.selector, modal.altSelector);
                if (selector) {
                    await testModal(modal.name, selector);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } else {
                    log(`Cannot find ${modal.name} button`, 'error');
                    stats.failCount++;
                    stats.modalCount++;
                    updateStats();
                }
            }

            // Summary
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log(`Test Complete: ${stats.passCount}/${stats.modalCount} passed`, 
                stats.passCount === stats.modalCount ? 'success' : 'warning');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
        }

        // Find working selector
        async function findWorkingSelector(primary, alternative) {
            const walletWindow = await waitForWallet();
            if (!walletWindow) return null;

            // Try finding button with text content
            const buttons = Array.from(walletWindow.document.querySelectorAll('button'));
            
            // Check primary text patterns
            const primaryTexts = primary.match(/"([^"]+)"/g);
            if (primaryTexts) {
                for (const textMatch of primaryTexts) {
                    const searchText = textMatch.replace(/"/g, '');
                    const button = buttons.find(btn => 
                        btn.textContent.includes(searchText) || 
                        btn.innerHTML.includes(searchText)
                    );
                    if (button) {
                        // Return a unique selector for this button
                        if (button.id) return `#${button.id}`;
                        if (button.className) return `button.${button.className.split(' ')[0]}`;
                        return `button:contains("${searchText}")`;
                    }
                }
            }

            // Try alternative selector
            if (alternative && walletWindow.document.querySelector(alternative)) {
                return alternative;
            }

            return null;
        }

        // Individual modal tests
        async function testAccountsModal() {
            await loadModalCloseFix();
            await new Promise(resolve => setTimeout(resolve, 1000));
            const selector = await findWorkingSelector('button:has-text("Accounts")', '[class*="accounts"]');
            if (selector) {
                await testModal('Accounts', selector);
            } else {
                log('Cannot find Accounts button', 'error');
            }
        }

        async function testSendModal() {
            await loadModalCloseFix();
            await new Promise(resolve => setTimeout(resolve, 1000));
            const selector = await findWorkingSelector('button:has-text("Send")', '[class*="send"]');
            if (selector) {
                await testModal('Send', selector);
            } else {
                log('Cannot find Send button', 'error');
            }
        }

        async function testReceiveModal() {
            await loadModalCloseFix();
            await new Promise(resolve => setTimeout(resolve, 1000));
            const selector = await findWorkingSelector('button:has-text("Receive")', '[class*="receive"]');
            if (selector) {
                await testModal('Receive', selector);
            } else {
                log('Cannot find Receive button', 'error');
            }
        }

        async function testSettingsModal() {
            await loadModalCloseFix();
            await new Promise(resolve => setTimeout(resolve, 1000));
            const selector = await findWorkingSelector('button:has-text("Settings")', '[class*="settings"]');
            if (selector) {
                await testModal('Settings', selector);
            } else {
                log('Cannot find Settings button', 'error');
            }
        }

        // Initialize on load
        window.addEventListener('load', async () => {
            log('Modal Close Navigation Test initialized', 'success');
            log('Loading wallet...', 'info');
            
            const walletWindow = await waitForWallet();
            if (walletWindow) {
                log('Ready to test modal navigation', 'success');
                log('Click "Run All Modal Tests" to begin', 'info');
            } else {
                log('Failed to load wallet', 'error');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        testAllModals();
                        break;
                    case 'l':
                        e.preventDefault();
                        clearLog();
                        break;
                }
            }
        });
    </script>
</body>
</html>