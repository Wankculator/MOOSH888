<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Edge Cases Test - MOOSH Wallet</title>
    <link rel="stylesheet" href="css/app.css">
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            padding: 20px;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-button {
            padding: 10px 20px;
            background: #000;
            border: 2px solid #f57315;
            color: #f57315;
            font-size: 14px;
            cursor: pointer;
            margin: 10px 0;
            display: block;
            width: 100%;
        }
        
        .test-button:hover {
            background: #f57315;
            color: #000;
        }
        
        .results {
            background: #111;
            border: 2px solid #333;
            padding: 20px;
            margin: 20px 0;
            white-space: pre-wrap;
            font-size: 12px;
        }
        
        .success { color: #69fd97; }
        .error { color: #ff4444; }
        .info { color: #00d4ff; }
        .warning { color: #f57315; }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="test-container">
        <h1 style="color: #f57315; text-align: center;">COLOR EDGE CASES TEST</h1>
        
        <button class="test-button" onclick="testNoAccounts()">Test with No Accounts</button>
        <button class="test-button" onclick="testManyAccounts()">Test with 20 Accounts</button>
        <button class="test-button" onclick="testRapidColorChanges()">Test Rapid Color Changes</button>
        <button class="test-button" onclick="testColorConflicts()">Test Color Conflicts</button>
        <button class="test-button" onclick="testInvalidColors()">Test Invalid Colors</button>
        
        <div class="results" id="results"></div>
    </div>
    
    <script src="js/moosh-wallet.js"></script>
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const time = new Date().toTimeString().split(' ')[0];
            results.innerHTML += `\n<span class="${type}">[${time}] ${message}</span>`;
            results.scrollTop = results.scrollHeight;
        }
        
        function clearLog() {
            results.innerHTML = '';
        }
        
        async function testNoAccounts() {
            clearLog();
            log('=== Testing with No Accounts ===', 'info');
            
            // Save current accounts
            const backup = window.app.state.get('accounts');
            
            try {
                // Clear accounts
                window.app.state.set('accounts', []);
                
                // Test getNextAccountColor
                const color = window.app.state.getNextAccountColor();
                if (color) {
                    log(`✓ getNextAccountColor returns ${color} with no accounts`, 'success');
                } else {
                    log('✗ getNextAccountColor fails with no accounts', 'error');
                }
                
                // Test opening modal with no accounts
                const modal = new AccountListModal(window.app);
                modal.show();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const modalEl = document.querySelector('.account-list-modal');
                if (modalEl) {
                    log('✓ Modal opens with no accounts', 'success');
                    
                    // Close modal
                    const closeBtn = modalEl.querySelector('button[onclick*="close"]');
                    if (closeBtn) closeBtn.click();
                } else {
                    log('✗ Modal fails to open with no accounts', 'error');
                }
                
            } catch (error) {
                log(`✗ Error: ${error.message}`, 'error');
            } finally {
                // Restore accounts
                window.app.state.set('accounts', backup);
            }
        }
        
        async function testManyAccounts() {
            clearLog();
            log('=== Testing with 20 Accounts ===', 'info');
            
            const backup = window.app.state.get('accounts');
            
            try {
                // Create 20 test accounts
                const testAccounts = [];
                for (let i = 0; i < 20; i++) {
                    testAccounts.push({
                        id: `test-${i}`,
                        name: `Test Account ${i + 1}`,
                        addresses: { segwit: `bc1qtest${i}` },
                        createdAt: Date.now() + i,
                        color: window.app.state.getAccountColors()[i % 8]
                    });
                }
                
                window.app.state.set('accounts', testAccounts);
                
                // Check color distribution
                const colorCounts = {};
                testAccounts.forEach(acc => {
                    colorCounts[acc.color] = (colorCounts[acc.color] || 0) + 1;
                });
                
                log('Color distribution:', 'info');
                Object.entries(colorCounts).forEach(([color, count]) => {
                    log(`  ${color}: ${count} accounts`, 'info');
                });
                
                // Test modal performance
                const start = performance.now();
                const modal = new AccountListModal(window.app);
                modal.show();
                const loadTime = performance.now() - start;
                
                log(`Modal load time with 20 accounts: ${loadTime.toFixed(2)}ms`, 
                    loadTime < 200 ? 'success' : 'warning');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Close modal
                const modalEl = document.querySelector('.account-list-modal');
                if (modalEl) {
                    const closeBtn = modalEl.querySelector('button[onclick*="close"]');
                    if (closeBtn) closeBtn.click();
                }
                
            } catch (error) {
                log(`✗ Error: ${error.message}`, 'error');
            } finally {
                window.app.state.set('accounts', backup);
            }
        }
        
        async function testRapidColorChanges() {
            clearLog();
            log('=== Testing Rapid Color Changes ===', 'info');
            
            try {
                const accounts = window.app.state.get('accounts');
                if (accounts.length === 0) {
                    log('✗ No accounts to test with', 'error');
                    return;
                }
                
                const account = accounts[0];
                const originalColor = account.color;
                const colors = window.app.state.getAccountColors();
                
                log(`Rapidly changing colors for "${account.name}"...`, 'info');
                
                // Change color 50 times rapidly
                const start = performance.now();
                for (let i = 0; i < 50; i++) {
                    window.app.state.updateAccountColor(account.id, colors[i % colors.length]);
                }
                const duration = performance.now() - start;
                
                log(`✓ 50 color changes in ${duration.toFixed(2)}ms`, 'success');
                
                // Check final state
                const finalAccount = window.app.state.get('accounts').find(a => a.id === account.id);
                if (finalAccount && finalAccount.color) {
                    log(`✓ Account still has valid color after rapid changes: ${finalAccount.color}`, 'success');
                } else {
                    log('✗ Account color corrupted after rapid changes', 'error');
                }
                
                // Restore original color
                window.app.state.updateAccountColor(account.id, originalColor);
                
            } catch (error) {
                log(`✗ Error: ${error.message}`, 'error');
            }
        }
        
        async function testColorConflicts() {
            clearLog();
            log('=== Testing Color Conflicts ===', 'info');
            
            try {
                const accounts = window.app.state.get('accounts');
                if (accounts.length < 2) {
                    log('✗ Need at least 2 accounts to test conflicts', 'error');
                    return;
                }
                
                // Set all accounts to same color
                const testColor = '#f57315';
                accounts.forEach(acc => {
                    window.app.state.updateAccountColor(acc.id, testColor);
                });
                
                // Check if all have same color
                const updatedAccounts = window.app.state.get('accounts');
                const allSameColor = updatedAccounts.every(acc => acc.color === testColor);
                
                if (allSameColor) {
                    log('✓ Multiple accounts can have same color', 'success');
                } else {
                    log('✗ Failed to set same color for all accounts', 'error');
                }
                
                // Test getNextAccountColor with all colors used
                const nextColor = window.app.state.getNextAccountColor();
                log(`getNextAccountColor returns: ${nextColor} when all have same color`, 'info');
                
            } catch (error) {
                log(`✗ Error: ${error.message}`, 'error');
            }
        }
        
        async function testInvalidColors() {
            clearLog();
            log('=== Testing Invalid Colors ===', 'info');
            
            try {
                const accounts = window.app.state.get('accounts');
                if (accounts.length === 0) {
                    log('✗ No accounts to test with', 'error');
                    return;
                }
                
                const account = accounts[0];
                const originalColor = account.color;
                
                // Test invalid color values
                const invalidColors = [
                    null,
                    undefined,
                    '',
                    'not-a-color',
                    '#xyz',
                    'rgb(300, 400, 500)',
                    '#ff',
                    12345
                ];
                
                invalidColors.forEach(invalidColor => {
                    try {
                        window.app.state.updateAccountColor(account.id, invalidColor);
                        const updated = window.app.state.get('accounts').find(a => a.id === account.id);
                        
                        if (updated.color === invalidColor) {
                            log(`✗ Accepted invalid color: ${invalidColor}`, 'error');
                        } else {
                            log(`✓ Rejected invalid color: ${invalidColor}`, 'success');
                        }
                    } catch (e) {
                        log(`✓ Properly threw error for: ${invalidColor}`, 'success');
                    }
                });
                
                // Restore original color
                window.app.state.updateAccountColor(account.id, originalColor);
                
            } catch (error) {
                log(`✗ Error: ${error.message}`, 'error');
            }
        }
        
        // Initial message
        window.addEventListener('load', () => {
            log('Edge case testing ready. Click buttons to test specific scenarios.', 'info');
        });
    </script>
</body>
</html>