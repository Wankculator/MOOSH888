<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Wallet - Complete Test Suite</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Loading screen styles */
        body {
            margin: 0;
            padding: 0;
            background: #000000;
            color: #ffffff;
            font-family: 'JetBrains Mono', monospace;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loader {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top: 3px solid #f57315;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Performance monitor */
        #performance-monitor {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #69fd97;
            padding: 10px;
            font-size: 11px;
            color: #69fd97;
            font-family: 'JetBrains Mono', monospace;
            z-index: 100000;
            min-width: 200px;
        }
        
        .perf-metric {
            margin: 2px 0;
        }
        
        .perf-metric.good { color: #69fd97; }
        .perf-metric.warning { color: #f57315; }
        .perf-metric.bad { color: #ff4444; }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loader"></div>
    </div>
    
    <noscript>
        <div>JavaScript is required to run MOOSH Wallet</div>
    </noscript>
    
    <!-- Performance Monitor -->
    <div id="performance-monitor">
        <div><strong>Performance Monitor</strong></div>
        <div class="perf-metric" id="fps">FPS: --</div>
        <div class="perf-metric" id="memory">Memory: --</div>
        <div class="perf-metric" id="load-time">Load Time: --</div>
        <div class="perf-metric" id="interactions">Interactions: 0</div>
    </div>
    
    <!-- Load all wallet components -->
    <script src="/js/moosh-wallet.js"></script>
    <script src="/wallet-accounts-fix.js"></script>
    <script src="/wallet-smoothness-enhancements.js"></script>
    
    <!-- Comprehensive test suite -->
    <script>
        // Performance monitoring
        const perfMonitor = {
            fps: 0,
            frameCount: 0,
            lastTime: performance.now(),
            interactions: 0,
            startTime: performance.now(),
            
            init() {
                this.measureFPS();
                this.measureMemory();
                this.trackInteractions();
                this.measureLoadTime();
            },
            
            measureFPS() {
                const currentTime = performance.now();
                this.frameCount++;
                
                if (currentTime >= this.lastTime + 1000) {
                    this.fps = Math.round((this.frameCount * 1000) / (currentTime - this.lastTime));
                    this.frameCount = 0;
                    this.lastTime = currentTime;
                    
                    const fpsElement = document.getElementById('fps');
                    fpsElement.textContent = `FPS: ${this.fps}`;
                    fpsElement.className = `perf-metric ${this.fps >= 50 ? 'good' : this.fps >= 30 ? 'warning' : 'bad'}`;
                }
                
                requestAnimationFrame(() => this.measureFPS());
            },
            
            measureMemory() {
                if (performance.memory) {
                    setInterval(() => {
                        const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(2);
                        const total = (performance.memory.totalJSHeapSize / 1048576).toFixed(2);
                        const memElement = document.getElementById('memory');
                        memElement.textContent = `Memory: ${used}/${total} MB`;
                        
                        const usage = (performance.memory.usedJSHeapSize / performance.memory.totalJSHeapSize) * 100;
                        memElement.className = `perf-metric ${usage < 50 ? 'good' : usage < 80 ? 'warning' : 'bad'}`;
                    }, 1000);
                }
            },
            
            trackInteractions() {
                ['click', 'keydown', 'scroll', 'touchstart'].forEach(event => {
                    document.addEventListener(event, () => {
                        this.interactions++;
                        document.getElementById('interactions').textContent = `Interactions: ${this.interactions}`;
                    });
                });
            },
            
            measureLoadTime() {
                window.addEventListener('load', () => {
                    const loadTime = ((performance.now() - this.startTime) / 1000).toFixed(2);
                    const loadElement = document.getElementById('load-time');
                    loadElement.textContent = `Load Time: ${loadTime}s`;
                    loadElement.className = `perf-metric ${loadTime < 2 ? 'good' : loadTime < 4 ? 'warning' : 'bad'}`;
                });
            }
        };
        
        // Automated test suite
        class WalletTestSuite {
            constructor() {
                this.tests = [];
                this.results = [];
            }
            
            async runAllTests() {
                console.log('🧪 Starting MOOSH Wallet Test Suite...');
                
                // Wait for wallet to fully load
                await this.waitForWallet();
                
                // Run tests
                await this.testWalletInitialization();
                await this.testAccountsButton();
                await this.testModalFunctionality();
                await this.testResponsiveness();
                await this.testPerformance();
                await this.testAccessibility();
                await this.testSecurity();
                
                // Report results
                this.reportResults();
            }
            
            async waitForWallet() {
                return new Promise((resolve) => {
                    const checkWallet = setInterval(() => {
                        if (window.MooshWallet && window.MooshWallet.ui && window.MooshWallet.state) {
                            clearInterval(checkWallet);
                            resolve();
                        }
                    }, 100);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        clearInterval(checkWallet);
                        resolve();
                    }, 10000);
                });
            }
            
            async testWalletInitialization() {
                const testName = 'Wallet Initialization';
                try {
                    const checks = {
                        'MooshWallet exists': !!window.MooshWallet,
                        'State manager exists': !!window.MooshWallet?.state,
                        'UI components exist': !!window.MooshWallet?.ui,
                        'Dashboard exists': !!window.MooshWallet?.ui?.dashboard,
                        'ElementFactory exists': !!window.ElementFactory
                    };
                    
                    const allPassed = Object.values(checks).every(v => v);
                    
                    this.results.push({
                        test: testName,
                        passed: allPassed,
                        details: checks
                    });
                } catch (error) {
                    this.results.push({
                        test: testName,
                        passed: false,
                        error: error.message
                    });
                }
            }
            
            async testAccountsButton() {
                const testName = 'Accounts Button Functionality';
                try {
                    // Find accounts button
                    const buttons = Array.from(document.querySelectorAll('button'));
                    const accountsButton = buttons.find(btn => 
                        btn.textContent.includes('Accounts') || 
                        btn.textContent.trim() === '+'
                    );
                    
                    if (!accountsButton) {
                        throw new Error('Accounts button not found');
                    }
                    
                    // Click button
                    accountsButton.click();
                    
                    // Wait for modal
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Check modal
                    const modal = document.querySelector('.modal-overlay');
                    const modalVisible = modal && window.getComputedStyle(modal).display !== 'none';
                    
                    this.results.push({
                        test: testName,
                        passed: modalVisible,
                        details: {
                            buttonFound: true,
                            modalCreated: !!modal,
                            modalVisible: modalVisible
                        }
                    });
                    
                    // Close modal if open
                    if (modal) {
                        modal.click();
                    }
                } catch (error) {
                    this.results.push({
                        test: testName,
                        passed: false,
                        error: error.message
                    });
                }
            }
            
            async testModalFunctionality() {
                const testName = 'Modal Interactions';
                try {
                    const modal = new (window.EnhancedMultiAccountModal || window.MultiAccountModal)(window.MooshWallet);
                    modal.show();
                    
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    const modalElement = document.querySelector('.modal-overlay');
                    const terminalBox = modalElement?.querySelector('.terminal-box');
                    
                    const checks = {
                        'Modal created': !!modalElement,
                        'Terminal box exists': !!terminalBox,
                        'Modal visible': window.getComputedStyle(modalElement).opacity === '1',
                        'Close button exists': !!modalElement?.querySelector('button')
                    };
                    
                    modal.close();
                    
                    this.results.push({
                        test: testName,
                        passed: Object.values(checks).every(v => v),
                        details: checks
                    });
                } catch (error) {
                    this.results.push({
                        test: testName,
                        passed: false,
                        error: error.message
                    });
                }
            }
            
            async testResponsiveness() {
                const testName = 'UI Responsiveness';
                try {
                    const viewportSizes = [
                        { width: 375, name: 'Mobile' },
                        { width: 768, name: 'Tablet' },
                        { width: 1920, name: 'Desktop' }
                    ];
                    
                    const results = {};
                    
                    for (const size of viewportSizes) {
                        // Set viewport width
                        document.documentElement.style.width = size.width + 'px';
                        
                        // Force reflow
                        document.documentElement.offsetHeight;
                        
                        // Check if UI adapted
                        const container = document.querySelector('.wallet-container, .moosh-wallet-container, #root');
                        if (container) {
                            const computedStyle = window.getComputedStyle(container);
                            results[size.name] = {
                                adapted: true,
                                fontSize: computedStyle.fontSize
                            };
                        }
                    }
                    
                    // Reset
                    document.documentElement.style.width = '';
                    
                    this.results.push({
                        test: testName,
                        passed: Object.keys(results).length === viewportSizes.length,
                        details: results
                    });
                } catch (error) {
                    this.results.push({
                        test: testName,
                        passed: false,
                        error: error.message
                    });
                }
            }
            
            async testPerformance() {
                const testName = 'Performance Metrics';
                try {
                    const metrics = {
                        'DOM nodes': document.querySelectorAll('*').length,
                        'Event listeners': performance.eventCounts ? performance.eventCounts : 'N/A',
                        'Memory usage': performance.memory ? 
                            `${(performance.memory.usedJSHeapSize / 1048576).toFixed(2)} MB` : 'N/A',
                        'FPS': perfMonitor.fps || 'Measuring...'
                    };
                    
                    const domNodesOk = metrics['DOM nodes'] < 3000;
                    const memoryOk = !performance.memory || performance.memory.usedJSHeapSize < 50 * 1048576;
                    
                    this.results.push({
                        test: testName,
                        passed: domNodesOk && memoryOk,
                        details: metrics
                    });
                } catch (error) {
                    this.results.push({
                        test: testName,
                        passed: false,
                        error: error.message
                    });
                }
            }
            
            async testAccessibility() {
                const testName = 'Accessibility';
                try {
                    const checks = {
                        'Buttons have text': Array.from(document.querySelectorAll('button'))
                            .every(btn => btn.textContent.trim() || btn.getAttribute('aria-label')),
                        'Inputs have labels': Array.from(document.querySelectorAll('input'))
                            .every(input => input.getAttribute('aria-label') || 
                                document.querySelector(`label[for="${input.id}"]`)),
                        'Focus visible': !!document.querySelector(':focus'),
                        'Semantic HTML': !!document.querySelector('main, nav, header, footer')
                    };
                    
                    this.results.push({
                        test: testName,
                        passed: checks['Buttons have text'] && checks['Inputs have labels'],
                        details: checks
                    });
                } catch (error) {
                    this.results.push({
                        test: testName,
                        passed: false,
                        error: error.message
                    });
                }
            }
            
            async testSecurity() {
                const testName = 'Security Checks';
                try {
                    const checks = {
                        'HTTPS check': window.location.protocol === 'https:' || 
                            window.location.hostname === 'localhost',
                        'No inline scripts': !document.querySelector('script:not([src])'),
                        'CSP header': !!document.querySelector('meta[http-equiv="Content-Security-Policy"]'),
                        'Secure storage': !!window.crypto && !!window.crypto.subtle
                    };
                    
                    this.results.push({
                        test: testName,
                        passed: checks['HTTPS check'] && checks['Secure storage'],
                        details: checks
                    });
                } catch (error) {
                    this.results.push({
                        test: testName,
                        passed: false,
                        error: error.message
                    });
                }
            }
            
            reportResults() {
                console.log('📊 Test Results:');
                console.log('================');
                
                let passed = 0;
                let failed = 0;
                
                this.results.forEach(result => {
                    const status = result.passed ? '✅' : '❌';
                    console.log(`${status} ${result.test}`);
                    
                    if (result.details) {
                        console.log('   Details:', result.details);
                    }
                    
                    if (result.error) {
                        console.error('   Error:', result.error);
                    }
                    
                    if (result.passed) passed++;
                    else failed++;
                });
                
                console.log('================');
                console.log(`Total: ${passed + failed} tests`);
                console.log(`Passed: ${passed} (${((passed / (passed + failed)) * 100).toFixed(1)}%)`);
                console.log(`Failed: ${failed}`);
                
                // Show visual notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${failed === 0 ? '#69fd97' : '#ff4444'};
                    color: #000;
                    padding: 20px;
                    font-family: 'JetBrains Mono', monospace;
                    z-index: 100001;
                    border: 2px solid #000;
                `;
                notification.innerHTML = `
                    <strong>Test Results</strong><br>
                    Passed: ${passed}/${passed + failed}<br>
                    ${failed === 0 ? 'All tests passed! 🎉' : `${failed} tests failed ⚠️`}
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 5000);
            }
        }
        
        // Initialize everything
        window.addEventListener('DOMContentLoaded', () => {
            // Start performance monitoring
            perfMonitor.init();
            
            // Run test suite after a delay
            setTimeout(() => {
                const testSuite = new WalletTestSuite();
                testSuite.runAllTests();
            }, 3000);
        });
        
        // Log console output
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            // Could send to monitoring service
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            // Could send to error tracking service
        };
    </script>
</body>
</html>