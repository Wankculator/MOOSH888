<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Test - Account Switcher Fix</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #f57315;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            border: 1px solid #f57315;
            padding: 20px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #111;
            border-left: 3px solid #f57315;
            font-size: 12px;
        }
        
        .status-ok { border-left-color: #00ff00; color: #00ff00; }
        .status-error { border-left-color: #ff0000; color: #ff0000; }
        .status-info { border-left-color: #f57315; color: #f57315; }
        .status-warning { border-left-color: #ffff00; color: #ffff00; }
        
        button {
            background: #000;
            color: #f57315;
            border: 2px solid #f57315;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s ease;
        }
        
        button:hover {
            background: #f57315;
            color: #000;
        }
        
        .dashboard-preview {
            background: #111;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #333;
            min-height: 200px;
        }
        
        #accountSwitcherContainer {
            display: inline-block;
            margin: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>[==] ACCOUNT SWITCHER FIX TEST [==]</h1>
            <p>Testing Account Switcher Functionality</p>
        </div>
        
        <div class="test-section">
            <h2>[>] Test Controls</h2>
            <button onclick="initializeWallet()">Initialize Wallet</button>
            <button onclick="createTestAccounts()">Create Test Accounts</button>
            <button onclick="testDropdown()">Test Dropdown Toggle</button>
            <button onclick="testAccountSwitch()">Test Account Switch</button>
            <button onclick="testMultiSelect()">Test Multi-Select</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div class="test-section">
            <h2>[>] Account Switcher Preview</h2>
            <div class="dashboard-preview">
                <div id="accountSwitcherContainer"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>[>] Current State</h2>
            <div id="current-state">
                <div>Current Account: <span id="current-account">Not loaded</span></div>
                <div>Active Accounts: <span id="active-accounts">Not loaded</span></div>
                <div>Dropdown State: <span id="dropdown-state">Closed</span></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>[>] Test Results</h2>
            <div id="test-results"></div>
        </div>
    </div>
    
    <!-- Load MOOSH Wallet -->
    <script src="/public/js/moosh-wallet.js"></script>
    
    <script>
        let app = null;
        let accountSwitcher = null;
        
        function logResult(message, status = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result status-${status}`;
            const timestamp = new Date().toLocaleTimeString();
            const indicator = status === 'ok' ? '[OK]' : status === 'error' ? '[X]' : status === 'warning' ? '[!!]' : '[>]';
            resultDiv.textContent = `${timestamp} ${indicator} ${message}`;
            resultsDiv.appendChild(resultDiv);
            console.log(`${indicator} ${message}`);
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            logResult('Results cleared', 'info');
        }
        
        function initializeWallet() {
            try {
                // Initialize app
                app = new MOOSHWallet();
                logResult('App initialized', 'ok');
                
                // Create at least one account if none exist
                const accounts = app.state.get('accounts') || [];
                if (accounts.length === 0) {
                    createTestAccounts();
                }
                
                // Mount AccountSwitcher
                const container = document.getElementById('accountSwitcherContainer');
                if (container) {
                    container.innerHTML = ''; // Clear existing
                    accountSwitcher = new AccountSwitcher(app);
                    accountSwitcher.mount(container);
                    logResult('AccountSwitcher mounted', 'ok');
                    
                    updateState();
                } else {
                    logResult('Container not found', 'error');
                }
                
            } catch (error) {
                logResult('Initialization failed: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        function createTestAccounts() {
            if (!app) {
                logResult('App not initialized', 'error');
                return;
            }
            
            const testAccounts = [
                {
                    id: 'test-1',
                    name: 'Main Wallet',
                    addresses: { bitcoin: 'bc1qtest1...', segwit: '3test1...' },
                    type: 'generated',
                    createdAt: Date.now()
                },
                {
                    id: 'test-2',
                    name: 'Trading Account',
                    addresses: { bitcoin: 'bc1qtest2...', segwit: '3test2...' },
                    type: 'generated',
                    createdAt: Date.now() - 86400000
                },
                {
                    id: 'test-3',
                    name: 'Savings',
                    addresses: { bitcoin: 'bc1qtest3...', segwit: '3test3...' },
                    type: 'imported',
                    createdAt: Date.now() - 172800000
                }
            ];
            
            app.state.set('accounts', testAccounts);
            app.state.set('currentAccountId', testAccounts[0].id);
            
            logResult(`Created ${testAccounts.length} test accounts`, 'ok');
            
            // Re-initialize AccountSwitcher with new accounts
            if (accountSwitcher) {
                accountSwitcher.update();
                updateState();
            }
        }
        
        function testDropdown() {
            if (!accountSwitcher) {
                logResult('AccountSwitcher not initialized', 'error');
                return;
            }
            
            // Find the trigger button
            const trigger = document.querySelector('.account-switcher-trigger');
            if (!trigger) {
                logResult('Trigger button not found', 'error');
                return;
            }
            
            // Click to open
            trigger.click();
            logResult('Clicked trigger button', 'info');
            
            setTimeout(() => {
                // Check if dropdown opened
                const dropdown = document.querySelector('.account-dropdown');
                if (dropdown && dropdown.style.display !== 'none') {
                    logResult('Dropdown opened successfully', 'ok');
                    
                    // Check dropdown contents
                    const items = dropdown.querySelectorAll('.account-item');
                    logResult(`Found ${items.length} account items in dropdown`, 'info');
                    
                    // Test close
                    setTimeout(() => {
                        trigger.click();
                        setTimeout(() => {
                            if (accountSwitcher.state.isOpen === false) {
                                logResult('Dropdown closed successfully', 'ok');
                            } else {
                                logResult('Dropdown did not close', 'error');
                            }
                            updateState();
                        }, 100);
                    }, 1000);
                } else {
                    logResult('Dropdown did not open', 'error');
                }
            }, 100);
        }
        
        function testAccountSwitch() {
            if (!accountSwitcher || !app) {
                logResult('Not initialized', 'error');
                return;
            }
            
            const accounts = app.state.getAccounts();
            if (accounts.length < 2) {
                logResult('Need at least 2 accounts to test switching', 'error');
                return;
            }
            
            const currentId = app.state.get('currentAccountId');
            const targetAccount = accounts.find(a => a.id !== currentId);
            
            logResult(`Switching from ${currentId} to ${targetAccount.id}`, 'info');
            
            accountSwitcher.switchToAccount(targetAccount.id);
            
            setTimeout(() => {
                const newId = app.state.get('currentAccountId');
                if (newId === targetAccount.id) {
                    logResult('Account switch successful', 'ok');
                } else {
                    logResult('Account switch failed', 'error');
                }
                updateState();
            }, 100);
        }
        
        function testMultiSelect() {
            if (!accountSwitcher) {
                logResult('AccountSwitcher not initialized', 'error');
                return;
            }
            
            const accounts = app.state.getAccounts();
            if (accounts.length < 2) {
                logResult('Need at least 2 accounts to test multi-select', 'error');
                return;
            }
            
            // Toggle second account
            accountSwitcher.toggleAccountActive(accounts[1].id);
            logResult(`Toggled account: ${accounts[1].name}`, 'info');
            
            setTimeout(() => {
                if (accountSwitcher.activeAccountIds.length === 2) {
                    logResult('Multi-select working - 2 accounts active', 'ok');
                } else {
                    logResult(`Expected 2 active accounts, got ${accountSwitcher.activeAccountIds.length}`, 'error');
                }
                updateState();
            }, 100);
        }
        
        function updateState() {
            // Update current account
            const currentAccount = app?.state?.getCurrentAccount();
            document.getElementById('current-account').textContent = 
                currentAccount ? currentAccount.name : 'None';
            
            // Update active accounts
            const activeCount = accountSwitcher?.activeAccountIds?.length || 0;
            document.getElementById('active-accounts').textContent = 
                `${activeCount} (${accountSwitcher?.activeAccountIds?.join(', ') || 'none'})`;
            
            // Update dropdown state
            document.getElementById('dropdown-state').textContent = 
                accountSwitcher?.state?.isOpen ? 'Open' : 'Closed';
        }
        
        // Initial log
        logResult('Account Switcher test ready', 'ok');
        logResult('Click "Initialize Wallet" to start', 'info');
    </script>
</body>
</html>