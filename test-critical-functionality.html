<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Wallet - Critical Functionality Test</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
            margin: 0;
        }
        
        h1 {
            color: #f57315;
            border-bottom: 2px solid #f57315;
            padding-bottom: 10px;
        }
        
        .test-section {
            background: #111;
            border: 1px solid #333;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #222;
            border: 1px solid #444;
        }
        
        .pass { color: #0f0; font-weight: bold; }
        .fail { color: #f00; font-weight: bold; }
        .pending { color: #ff0; }
        .info { color: #0ff; }
        
        button {
            background: #f57315;
            border: none;
            color: #000;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        
        button:hover {
            background: #ff8525;
        }
        
        #log {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .critical {
            background: #400;
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #f00;
        }
        
        .warning {
            background: #440;
            padding: 5px;
            margin: 2px 0;
            border-left: 3px solid #ff0;
        }
    </style>
</head>
<body>
    <h1>üîç MOOSH Wallet Critical Functionality Test</h1>
    <p>Testing according to CLAUDE.md guidelines - SEED GENERATION IS CRITICAL</p>

    <div class="test-section">
        <h2>1Ô∏è‚É£ CRITICAL: Seed Generation Tests</h2>
        <div id="seed-tests"></div>
    </div>

    <div class="test-section">
        <h2>2Ô∏è‚É£ Core Wallet Functionality</h2>
        <div id="core-tests"></div>
    </div>

    <div class="test-section">
        <h2>3Ô∏è‚É£ Multi-Wallet Features (Phase 0-4)</h2>
        <div id="multi-tests"></div>
    </div>

    <div class="test-section">
        <h2>4Ô∏è‚É£ Phase 5 Module Loading</h2>
        <div id="phase5-tests"></div>
    </div>

    <div class="test-section">
        <h2>5Ô∏è‚É£ Performance Metrics</h2>
        <div id="perf-tests"></div>
    </div>

    <div class="test-section">
        <h2>üêõ Issues Found</h2>
        <div id="issues"></div>
    </div>

    <button onclick="runTests()">Run All Tests</button>
    <button onclick="clearLog()">Clear Log</button>

    <div id="log"></div>

    <script>
        let testResults = {
            passed: 0,
            failed: 0,
            critical: []
        };

        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function addTestResult(containerId, testName, status, details = '') {
            const container = document.getElementById(containerId);
            const testEl = document.createElement('div');
            testEl.className = 'test-item';
            testEl.innerHTML = `
                <span>${testName}</span>
                <span class="${status}">${status.toUpperCase()} ${details ? '- ' + details : ''}</span>
            `;
            container.appendChild(testEl);
            
            if (status === 'pass') {
                testResults.passed++;
            } else if (status === 'fail') {
                testResults.failed++;
                if (containerId === 'seed-tests') {
                    testResults.critical.push(testName);
                }
            }
        }

        async function testSeedGeneration() {
            log('Testing seed generation - CRITICAL FUNCTIONALITY', 'critical');
            
            // Test 12-word seed
            try {
                log('Testing 12-word seed generation...');
                const start = performance.now();
                
                const response = await fetch('http://localhost:3001/api/spark/generate-wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strength: 128 })
                });
                
                const time = performance.now() - start;
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Verify response structure
                if (!data.success || !data.data) {
                    throw new Error('Invalid response structure');
                }
                
                if (typeof data.data.mnemonic !== 'string') {
                    throw new Error('Mnemonic must be string, not array');
                }
                
                const words = data.data.mnemonic.split(' ');
                if (words.length !== 12) {
                    throw new Error(`Expected 12 words, got ${words.length}`);
                }
                
                // Check all required fields
                const required = [
                    data.data.addresses?.bitcoin,
                    data.data.addresses?.spark,
                    data.data.privateKeys?.bitcoin?.wif,
                    data.data.privateKeys?.bitcoin?.hex,
                    data.data.privateKeys?.spark?.hex
                ];
                
                if (required.some(field => !field)) {
                    throw new Error('Missing required fields in response');
                }
                
                addTestResult('seed-tests', '12-word seed generation', 'pass', `${time.toFixed(0)}ms`);
                log(`‚úì 12-word seed generated in ${time.toFixed(0)}ms`);
                
            } catch (error) {
                addTestResult('seed-tests', '12-word seed generation', 'fail', error.message);
                log(`‚úó 12-word seed generation failed: ${error.message}`, 'critical');
            }
            
            // Test 24-word seed
            try {
                log('Testing 24-word seed generation...');
                const start = performance.now();
                
                const response = await fetch('http://localhost:3001/api/spark/generate-wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strength: 256 })
                });
                
                const time = performance.now() - start;
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const words = data.data.mnemonic.split(' ');
                if (words.length !== 24) {
                    throw new Error(`Expected 24 words, got ${words.length}`);
                }
                
                addTestResult('seed-tests', '24-word seed generation', 'pass', `${time.toFixed(0)}ms`);
                log(`‚úì 24-word seed generated in ${time.toFixed(0)}ms`);
                
            } catch (error) {
                addTestResult('seed-tests', '24-word seed generation', 'fail', error.message);
                log(`‚úó 24-word seed generation failed: ${error.message}`, 'critical');
            }
            
            // Test endpoint URL (must be /api/spark/generate-wallet)
            try {
                log('Verifying correct endpoint URL...');
                const response = await fetch('http://localhost:3001/api/spark/generate-wallet', {
                    method: 'OPTIONS'
                });
                
                if (response.status === 404) {
                    throw new Error('Endpoint not found - URL may have changed!');
                }
                
                addTestResult('seed-tests', 'Endpoint URL verification', 'pass');
                log('‚úì Endpoint URL is correct');
                
            } catch (error) {
                addTestResult('seed-tests', 'Endpoint URL verification', 'fail', error.message);
                log(`‚úó Endpoint URL check failed: ${error.message}`, 'critical');
            }
        }

        async function testCoreWallet() {
            log('Testing core wallet functionality...');
            
            // Load wallet page
            try {
                const response = await fetch('http://localhost:3001/');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                addTestResult('core-tests', 'Wallet page loads', 'pass');
                log('‚úì Wallet page loads successfully');
            } catch (error) {
                addTestResult('core-tests', 'Wallet page loads', 'fail', error.message);
                log(`‚úó Wallet page failed to load: ${error.message}`, 'warning');
            }
            
            // Check if main JS loads
            try {
                const response = await fetch('http://localhost:3001/js/moosh-wallet.js');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const size = response.headers.get('content-length');
                addTestResult('core-tests', 'Main JS loads', 'pass', `${(size/1024).toFixed(1)}KB`);
                log(`‚úì Main JS loaded (${(size/1024).toFixed(1)}KB)`);
            } catch (error) {
                addTestResult('core-tests', 'Main JS loads', 'fail', error.message);
                log(`‚úó Main JS failed to load: ${error.message}`, 'critical');
            }
        }

        async function testMultiWallet() {
            log('Testing multi-wallet features...');
            
            const phase04Scripts = [
                'multi-wallet-extensions.js',
                'multi-wallet-ui.js',
                'portfolio-connector.js',
                'multi-wallet-portfolio.js',
                'wallet-grouping-system.js',
                'bulk-operations.js',
                'wallet-search-filter.js'
            ];
            
            for (const script of phase04Scripts) {
                try {
                    const response = await fetch(`http://localhost:3001/js/${script}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    addTestResult('multi-tests', `Load ${script}`, 'pass');
                } catch (error) {
                    addTestResult('multi-tests', `Load ${script}`, 'fail', error.message);
                    log(`‚úó Failed to load ${script}: ${error.message}`, 'warning');
                }
            }
        }

        async function testPhase5Modules() {
            log('Testing Phase 5 module loading...');
            
            const phase5Modules = [
                { name: 'error-handling.js', critical: true },
                { name: 'ui-polish.js', critical: true },
                { name: 'wallet-import-export.js', critical: false },
                { name: 'wallet-analytics.js', critical: false },
                { name: 'transaction-routing.js', critical: false },
                { name: 'ordinals-aggregation.js', critical: false },
                { name: 'wallet-security.js', critical: false },
                { name: 'performance-optimization.js', critical: false },
                { name: 'enhanced-import.js', critical: false }
            ];
            
            for (const module of phase5Modules) {
                try {
                    const response = await fetch(`http://localhost:3001/js/${module.name}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    addTestResult('phase5-tests', `Load ${module.name}`, 'pass');
                } catch (error) {
                    addTestResult('phase5-tests', `Load ${module.name}`, 'fail', error.message);
                    if (module.critical) {
                        log(`‚úó CRITICAL: Failed to load ${module.name}: ${error.message}`, 'critical');
                    } else {
                        log(`‚úó Failed to load ${module.name}: ${error.message}`, 'warning');
                    }
                }
            }
        }

        async function testPerformance() {
            log('Testing performance metrics...');
            
            try {
                const start = performance.now();
                const response = await fetch('http://localhost:3001/');
                await response.text();
                const loadTime = performance.now() - start;
                
                const status = loadTime < 1000 ? 'pass' : loadTime < 3000 ? 'pass' : 'fail';
                const details = loadTime < 1000 ? 'Excellent' : loadTime < 3000 ? 'Acceptable' : 'Too slow';
                
                addTestResult('perf-tests', 'Page load time', status, `${loadTime.toFixed(0)}ms - ${details}`);
                log(`Page loaded in ${loadTime.toFixed(0)}ms - ${details}`);
                
            } catch (error) {
                addTestResult('perf-tests', 'Page load time', 'fail', error.message);
            }
            
            // Check if integration fixes are working
            try {
                const response = await fetch('http://localhost:3001/js/integration-fixes.js');
                if (!response.ok) throw new Error('Integration fixes not loaded');
                
                addTestResult('perf-tests', 'Integration fixes loaded', 'pass');
            } catch (error) {
                addTestResult('perf-tests', 'Integration fixes loaded', 'fail');
            }
            
            // Check if performance fix is working
            try {
                const response = await fetch('http://localhost:3001/js/performance-fix.js');
                if (!response.ok) throw new Error('Performance fix not loaded');
                
                addTestResult('perf-tests', 'Performance optimizations loaded', 'pass');
            } catch (error) {
                addTestResult('perf-tests', 'Performance optimizations loaded', 'fail');
            }
        }

        async function runTests() {
            // Clear previous results
            document.getElementById('seed-tests').innerHTML = '';
            document.getElementById('core-tests').innerHTML = '';
            document.getElementById('multi-tests').innerHTML = '';
            document.getElementById('phase5-tests').innerHTML = '';
            document.getElementById('perf-tests').innerHTML = '';
            document.getElementById('issues').innerHTML = '';
            testResults = { passed: 0, failed: 0, critical: [] };
            
            log('Starting comprehensive test suite...', 'info');
            
            // Run tests
            await testSeedGeneration();
            await testCoreWallet();
            await testMultiWallet();
            await testPhase5Modules();
            await testPerformance();
            
            // Summary
            log(`\nTest Summary: ${testResults.passed} passed, ${testResults.failed} failed`, 
                testResults.failed === 0 ? 'info' : 'warning');
            
            // Show critical issues
            if (testResults.critical.length > 0) {
                const issuesEl = document.getElementById('issues');
                testResults.critical.forEach(issue => {
                    const div = document.createElement('div');
                    div.className = 'critical';
                    div.textContent = `CRITICAL: ${issue} failed`;
                    issuesEl.appendChild(div);
                });
            } else {
                document.getElementById('issues').innerHTML = '<div class="pass">No critical issues found!</div>';
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Auto-run tests when page loads
        window.addEventListener('load', () => {
            log('Test page loaded. Click "Run All Tests" to begin.', 'info');
        });
    </script>
</body>
</html>