<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Test - Debounced Update Fix</title>
    <link rel="stylesheet" href="public/css/moosh-wallet.css">
    <style>
        body {
            background: #000000;
            color: #f57315;
            font-family: 'Courier New', monospace;
            padding: 20px;
        }
        
        .test-results {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #f57315;
            background: #111111;
        }
        
        .test-item {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid #333333;
        }
        
        .test-item.success {
            border-left-color: #00ff00;
        }
        
        .test-item.error {
            border-left-color: #ff0000;
        }
        
        .test-item.info {
            border-left-color: #f57315;
        }
        
        .status-indicator {
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>[>] Debounced Update Fix Test</h1>
    <p>Testing that debouncedUpdateLiveData is properly initialized in constructor</p>
    
    <div class="test-results" id="testResults">
        <h2>[=] Test Results</h2>
    </div>
    
    <script src="public/js/moosh-wallet.js"></script>
    <script>
        const results = document.getElementById('testResults');
        
        function logTest(message, status = 'info') {
            const item = document.createElement('div');
            item.className = `test-item ${status}`;
            
            const indicator = status === 'success' ? '[OK]' : 
                            status === 'error' ? '[X]' : '[>]';
            
            item.innerHTML = `<span class="status-indicator">${indicator}</span> ${message}`;
            results.appendChild(item);
            
            console.log(`${indicator} ${message}`);
        }
        
        // Test 1: Check if ComplianceUtils exists
        if (typeof ComplianceUtils !== 'undefined') {
            logTest('ComplianceUtils is loaded', 'success');
        } else {
            logTest('ComplianceUtils is not loaded', 'error');
        }
        
        // Test 2: Create a mock app object
        const mockApp = {
            state: {
                get: (key) => {
                    const mockState = {
                        currentAccountId: 'test-account-1',
                        accounts: [],
                        selectedWalletType: 'nativeSegWit'
                    };
                    return mockState[key];
                },
                set: () => {},
                update: () => {},
                on: () => {},
                off: () => {}
            },
            showNotification: (msg, type) => {
                logTest(`Notification: ${msg} (${type})`, type === 'error' ? 'error' : 'info');
            },
            router: {
                navigate: (page) => {
                    logTest(`Would navigate to: ${page}`, 'info');
                }
            }
        };
        
        // Test 3: Create DashboardPage instance
        try {
            const dashboard = new DashboardPage(mockApp);
            logTest('DashboardPage instance created successfully', 'success');
            
            // Test 4: Check if debouncedUpdateLiveData exists
            if (typeof dashboard.debouncedUpdateLiveData === 'function') {
                logTest('debouncedUpdateLiveData is initialized in constructor', 'success');
            } else {
                logTest('debouncedUpdateLiveData is NOT initialized in constructor', 'error');
            }
            
            // Test 5: Try to render (this would previously fail)
            try {
                // Mock localStorage data to prevent redirect
                localStorage.setItem('sparkWallet', JSON.stringify({
                    addresses: {
                        bitcoin: 'bc1test...',
                        spark: 'spark1test...'
                    }
                }));
                localStorage.setItem('generatedSeed', JSON.stringify(['word1', 'word2', 'word3']));
                
                const rendered = dashboard.render();
                if (rendered) {
                    logTest('Dashboard render() completed without errors', 'success');
                } else {
                    logTest('Dashboard render() returned null/undefined', 'error');
                }
            } catch (renderError) {
                logTest('Dashboard render() threw error: ' + renderError.message, 'error');
            }
            
            // Test 6: Check if createPriceTicker works
            try {
                if (typeof dashboard.createPriceTicker === 'function') {
                    const priceTicker = dashboard.createPriceTicker();
                    if (priceTicker) {
                        logTest('createPriceTicker() executed successfully', 'success');
                    } else {
                        logTest('createPriceTicker() returned null/undefined', 'error');
                    }
                } else {
                    logTest('createPriceTicker method not found', 'error');
                }
            } catch (tickerError) {
                logTest('createPriceTicker() threw error: ' + tickerError.message, 'error');
            }
            
        } catch (error) {
            logTest('Failed to create DashboardPage: ' + error.message, 'error');
            console.error(error);
        }
        
        // Clean up test data
        setTimeout(() => {
            localStorage.removeItem('sparkWallet');
            localStorage.removeItem('generatedSeed');
            logTest('Test data cleaned up', 'info');
        }, 1000);
    </script>
</body>
</html>