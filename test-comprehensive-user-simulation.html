<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Wallet - Comprehensive User Simulation Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            background: #1a1a1a;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .test-section {
            background: #111;
            border: 1px solid #333;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-category {
            background: #1a1a1a;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #f57315;
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #222;
            border: 1px solid #444;
        }
        
        .test-result {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 12px;
        }
        
        .pass { background: #4caf50; color: #fff; }
        .fail { background: #f44336; color: #fff; }
        .warning { background: #ff9800; color: #000; }
        .pending { background: #666; color: #fff; }
        
        .test-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        button {
            background: #f57315;
            border: none;
            color: #000;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
        }
        
        button:hover {
            background: #ff8525;
        }
        
        .bug-report {
            background: #2a0a0a;
            border: 2px solid #f44336;
            padding: 15px;
            margin: 10px 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #1a1a1a;
            padding: 15px;
            text-align: center;
            border: 1px solid #444;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        #test-log {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .critical { color: #ff0000; font-weight: bold; }
        .high { color: #ff9800; }
        .medium { color: #ffeb3b; }
        .low { color: #4caf50; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üîç MOOSH Wallet Comprehensive Test Suite</h1>
            <p>Full User Simulation & Bug Detection</p>
            <div id="test-timestamp"></div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div>Total Tests</div>
                <div class="stat-value" id="total-tests">0</div>
            </div>
            <div class="stat-card">
                <div>Passed</div>
                <div class="stat-value" id="passed-tests" style="color: #4caf50;">0</div>
            </div>
            <div class="stat-card">
                <div>Failed</div>
                <div class="stat-value" id="failed-tests" style="color: #f44336;">0</div>
            </div>
            <div class="stat-card">
                <div>Warnings</div>
                <div class="stat-value" id="warning-tests" style="color: #ff9800;">0</div>
            </div>
        </div>

        <div class="test-section">
            <h2>üéØ Core Functionality Tests</h2>
            
            <div class="test-category">
                <h3>Wallet Generation & Seed Management</h3>
                <div id="seed-tests"></div>
            </div>

            <div class="test-category">
                <h3>UI Elements & Buttons</h3>
                <div id="ui-tests"></div>
            </div>

            <div class="test-category">
                <h3>Multi-Wallet Features</h3>
                <div id="multi-wallet-tests"></div>
            </div>

            <div class="test-category">
                <h3>Phase 5 Enterprise Features</h3>
                <div id="enterprise-tests"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üêõ Bug Report</h2>
            <div id="bug-report"></div>
        </div>

        <div class="test-section">
            <h2>üìä Performance Metrics</h2>
            <div id="performance-metrics"></div>
        </div>

        <div class="test-section">
            <h2>üìù Test Log</h2>
            <div id="test-log"></div>
        </div>

        <div class="test-controls">
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="exportReport()">Export Report</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
    </div>

    <iframe id="wallet-frame" src="/index.html" style="display: none;"></iframe>

    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0,
            bugs: [],
            performance: {}
        };

        let walletApp = null;
        let testLog = [];

        // Test definitions
        const testSuites = {
            seed: [
                {
                    name: "Generate 12-word seed",
                    test: async () => {
                        const startTime = performance.now();
                        try {
                            const response = await fetch('/api/spark/generate-wallet', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ strength: 128 })
                            });
                            const data = await response.json();
                            const endTime = performance.now();
                            
                            if (!data.success || !data.data.mnemonic) {
                                throw new Error('Invalid response structure');
                            }
                            
                            const words = data.data.mnemonic.split(' ');
                            if (words.length !== 12) {
                                throw new Error(`Expected 12 words, got ${words.length}`);
                            }
                            
                            return {
                                status: 'pass',
                                time: endTime - startTime,
                                details: `Generated in ${(endTime - startTime).toFixed(2)}ms`
                            };
                        } catch (error) {
                            return {
                                status: 'fail',
                                error: error.message,
                                critical: true
                            };
                        }
                    }
                },
                {
                    name: "Generate 24-word seed",
                    test: async () => {
                        const startTime = performance.now();
                        try {
                            const response = await fetch('/api/spark/generate-wallet', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ strength: 256 })
                            });
                            const data = await response.json();
                            const endTime = performance.now();
                            
                            const words = data.data.mnemonic.split(' ');
                            if (words.length !== 24) {
                                throw new Error(`Expected 24 words, got ${words.length}`);
                            }
                            
                            return {
                                status: 'pass',
                                time: endTime - startTime,
                                details: `Generated in ${(endTime - startTime).toFixed(2)}ms`
                            };
                        } catch (error) {
                            return {
                                status: 'fail',
                                error: error.message,
                                critical: true
                            };
                        }
                    }
                },
                {
                    name: "Verify response structure",
                    test: async () => {
                        try {
                            const response = await fetch('/api/spark/generate-wallet', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ strength: 128 })
                            });
                            const data = await response.json();
                            
                            const requiredFields = [
                                'data.mnemonic',
                                'data.addresses.bitcoin',
                                'data.addresses.spark',
                                'data.privateKeys.bitcoin.wif',
                                'data.privateKeys.bitcoin.hex',
                                'data.privateKeys.spark.hex'
                            ];
                            
                            const missing = [];
                            for (const field of requiredFields) {
                                const value = field.split('.').reduce((obj, key) => obj?.[key], data);
                                if (!value) missing.push(field);
                            }
                            
                            if (missing.length > 0) {
                                throw new Error(`Missing fields: ${missing.join(', ')}`);
                            }
                            
                            return { status: 'pass' };
                        } catch (error) {
                            return {
                                status: 'fail',
                                error: error.message,
                                critical: true
                            };
                        }
                    }
                }
            ],
            ui: [
                {
                    name: "Check generate wallet button exists",
                    test: async () => {
                        await waitForWallet();
                        const btn = walletApp.document.querySelector('.generate-wallet-btn');
                        return btn ? { status: 'pass' } : { status: 'fail', error: 'Button not found' };
                    }
                },
                {
                    name: "Check multi-wallet toggle exists",
                    test: async () => {
                        await waitForWallet();
                        const toggle = walletApp.document.querySelector('.multi-wallet-toggle');
                        return toggle ? { status: 'pass' } : { status: 'fail', error: 'Toggle not found' };
                    }
                },
                {
                    name: "Check account list renders",
                    test: async () => {
                        await waitForWallet();
                        const list = walletApp.document.querySelector('.account-list');
                        return list ? { status: 'pass' } : { status: 'fail', error: 'Account list not found' };
                    }
                },
                {
                    name: "Check send button functionality",
                    test: async () => {
                        await waitForWallet();
                        const sendBtn = walletApp.document.querySelector('.send-btn');
                        if (!sendBtn) return { status: 'fail', error: 'Send button not found' };
                        
                        // Check if clicking opens modal
                        sendBtn.click();
                        await sleep(500);
                        
                        const modal = walletApp.document.querySelector('.send-modal');
                        return modal ? { status: 'pass' } : { status: 'warning', error: 'Send modal did not open' };
                    }
                },
                {
                    name: "Check receive button functionality",
                    test: async () => {
                        await waitForWallet();
                        const receiveBtn = walletApp.document.querySelector('.receive-btn');
                        if (!receiveBtn) return { status: 'fail', error: 'Receive button not found' };
                        
                        receiveBtn.click();
                        await sleep(500);
                        
                        const modal = walletApp.document.querySelector('.receive-modal');
                        return modal ? { status: 'pass' } : { status: 'warning', error: 'Receive modal did not open' };
                    }
                },
                {
                    name: "Check theme toggle",
                    test: async () => {
                        await waitForWallet();
                        const themeToggle = walletApp.document.querySelector('.theme-toggle');
                        if (!themeToggle) return { status: 'fail', error: 'Theme toggle not found' };
                        
                        const initialTheme = walletApp.document.documentElement.getAttribute('data-theme');
                        themeToggle.click();
                        await sleep(100);
                        const newTheme = walletApp.document.documentElement.getAttribute('data-theme');
                        
                        return initialTheme !== newTheme ? 
                            { status: 'pass' } : 
                            { status: 'fail', error: 'Theme did not change' };
                    }
                }
            ],
            multiWallet: [
                {
                    name: "Enable multi-wallet mode",
                    test: async () => {
                        await waitForWallet();
                        const toggle = walletApp.document.querySelector('.multi-wallet-toggle input');
                        if (!toggle) return { status: 'fail', error: 'Multi-wallet toggle not found' };
                        
                        toggle.click();
                        await sleep(500);
                        
                        // Check if multi-wallet UI appears
                        const multiUI = walletApp.document.querySelector('.multi-wallet-ui');
                        return multiUI ? { status: 'pass' } : { status: 'fail', error: 'Multi-wallet UI did not appear' };
                    }
                },
                {
                    name: "Check wallet selection checkboxes",
                    test: async () => {
                        await waitForWallet();
                        const checkboxes = walletApp.document.querySelectorAll('.wallet-selector input[type="checkbox"]');
                        return checkboxes.length > 0 ? 
                            { status: 'pass', details: `Found ${checkboxes.length} wallet checkboxes` } : 
                            { status: 'fail', error: 'No wallet selection checkboxes found' };
                    }
                },
                {
                    name: "Test select all wallets",
                    test: async () => {
                        await waitForWallet();
                        const selectAllBtn = walletApp.document.querySelector('.select-all-btn');
                        if (!selectAllBtn) return { status: 'fail', error: 'Select all button not found' };
                        
                        selectAllBtn.click();
                        await sleep(200);
                        
                        const checkboxes = walletApp.document.querySelectorAll('.wallet-selector input[type="checkbox"]:checked');
                        const totalCheckboxes = walletApp.document.querySelectorAll('.wallet-selector input[type="checkbox"]');
                        
                        return checkboxes.length === totalCheckboxes.length ? 
                            { status: 'pass' } : 
                            { status: 'fail', error: 'Not all wallets selected' };
                    }
                },
                {
                    name: "Check portfolio view",
                    test: async () => {
                        await waitForWallet();
                        const portfolioView = walletApp.document.querySelector('.portfolio-view');
                        return portfolioView ? { status: 'pass' } : { status: 'warning', error: 'Portfolio view not found' };
                    }
                }
            ],
            enterprise: [
                {
                    name: "Import/Export panel",
                    test: async () => {
                        await waitForWallet();
                        const panel = walletApp.document.getElementById('wallet-import-panel');
                        const exportBtn = walletApp.document.querySelector('.export-wallets-btn');
                        const importBtn = walletApp.document.querySelector('.import-wallets-btn');
                        
                        if (!panel) return { status: 'fail', error: 'Import/Export panel not found' };
                        if (!exportBtn || !importBtn) {
                            return { status: 'warning', error: 'Import/Export buttons missing' };
                        }
                        
                        return { status: 'pass' };
                    }
                },
                {
                    name: "Analytics dashboard",
                    test: async () => {
                        await waitForWallet();
                        const dashboard = walletApp.document.getElementById('analytics-dashboard');
                        if (!dashboard) return { status: 'fail', error: 'Analytics dashboard not found' };
                        
                        // Check if in multi-wallet mode
                        const isMultiMode = walletApp.state?.walletMode === 'multi';
                        if (!isMultiMode) {
                            return { status: 'warning', error: 'Analytics only visible in multi-wallet mode' };
                        }
                        
                        return { status: 'pass' };
                    }
                },
                {
                    name: "Transaction routing",
                    test: async () => {
                        await waitForWallet();
                        // Open send modal
                        const sendBtn = walletApp.document.querySelector('.send-btn');
                        if (sendBtn) sendBtn.click();
                        await sleep(500);
                        
                        const walletSelector = walletApp.document.querySelector('.wallet-selector-dropdown');
                        return walletSelector ? 
                            { status: 'pass' } : 
                            { status: 'warning', error: 'Wallet selector in send modal not found' };
                    }
                },
                {
                    name: "Security panel",
                    test: async () => {
                        await waitForWallet();
                        const securityPanel = walletApp.document.getElementById('security-panel');
                        const pinSetup = walletApp.document.querySelector('.setup-pin-btn');
                        const sessionTimeout = walletApp.document.getElementById('session-timeout-select');
                        
                        if (!securityPanel) return { status: 'fail', error: 'Security panel not found' };
                        if (!pinSetup || !sessionTimeout) {
                            return { status: 'warning', error: 'Some security controls missing' };
                        }
                        
                        return { status: 'pass' };
                    }
                },
                {
                    name: "Performance optimization",
                    test: async () => {
                        await waitForWallet();
                        const virtualScroll = walletApp.document.querySelector('.virtual-scroll-container');
                        const hasOptimization = walletApp.performanceOptimization !== undefined;
                        
                        if (!hasOptimization) {
                            return { status: 'fail', error: 'Performance optimization module not loaded' };
                        }
                        
                        return { status: 'pass', details: 'Performance module loaded' };
                    }
                },
                {
                    name: "Error handling",
                    test: async () => {
                        await waitForWallet();
                        const hasErrorHandling = walletApp.errorHandling !== undefined;
                        
                        if (!hasErrorHandling) {
                            return { status: 'fail', error: 'Error handling module not loaded' };
                        }
                        
                        // Test error notification
                        try {
                            walletApp.showNotification('Test error', 'error');
                            await sleep(100);
                            const notification = walletApp.document.querySelector('.error-notification');
                            return notification ? 
                                { status: 'pass' } : 
                                { status: 'warning', error: 'Error notification not displayed' };
                        } catch (e) {
                            return { status: 'fail', error: 'Error handling test failed' };
                        }
                    }
                },
                {
                    name: "UI Polish features",
                    test: async () => {
                        await waitForWallet();
                        const hasUIPolish = walletApp.uiPolish !== undefined;
                        const undoBtn = walletApp.document.getElementById('undo-btn');
                        const redoBtn = walletApp.document.getElementById('redo-btn');
                        const notificationContainer = walletApp.document.getElementById('notification-container');
                        
                        if (!hasUIPolish) {
                            return { status: 'fail', error: 'UI Polish module not loaded' };
                        }
                        
                        if (!undoBtn || !redoBtn) {
                            return { status: 'warning', error: 'Undo/Redo buttons not found' };
                        }
                        
                        if (!notificationContainer) {
                            return { status: 'warning', error: 'Notification container not found' };
                        }
                        
                        return { status: 'pass' };
                    }
                }
            ]
        };

        // Helper functions
        async function waitForWallet() {
            const frame = document.getElementById('wallet-frame');
            walletApp = frame.contentWindow;
            
            // Wait for app to load
            let attempts = 0;
            while (!walletApp.app && attempts < 50) {
                await sleep(100);
                attempts++;
            }
            
            if (!walletApp.app) {
                throw new Error('Wallet app failed to load');
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function log(message, level = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] [${level.toUpperCase()}] ${message}`;
            testLog.push(logEntry);
            
            const logEl = document.getElementById('test-log');
            const entry = document.createElement('div');
            entry.className = level;
            entry.textContent = logEntry;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function runTestSuite(suiteName, tests, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            for (const test of tests) {
                testResults.total++;
                const testItem = document.createElement('div');
                testItem.className = 'test-item';
                
                const nameEl = document.createElement('div');
                nameEl.textContent = test.name;
                testItem.appendChild(nameEl);
                
                const resultEl = document.createElement('div');
                resultEl.className = 'test-result pending';
                resultEl.textContent = 'Running...';
                testItem.appendChild(resultEl);
                
                container.appendChild(testItem);
                
                try {
                    log(`Running test: ${test.name}`);
                    const result = await test.test();
                    
                    resultEl.className = `test-result ${result.status}`;
                    resultEl.textContent = result.status.toUpperCase();
                    
                    if (result.details) {
                        resultEl.title = result.details;
                    }
                    
                    if (result.status === 'pass') {
                        testResults.passed++;
                        log(`‚úì ${test.name} passed`, 'low');
                    } else if (result.status === 'fail') {
                        testResults.failed++;
                        log(`‚úó ${test.name} failed: ${result.error}`, result.critical ? 'critical' : 'high');
                        
                        if (result.critical) {
                            testResults.bugs.push({
                                test: test.name,
                                error: result.error,
                                severity: 'CRITICAL',
                                suite: suiteName
                            });
                        }
                    } else if (result.status === 'warning') {
                        testResults.warnings++;
                        log(`‚ö† ${test.name} warning: ${result.error}`, 'medium');
                    }
                    
                    if (result.time) {
                        testResults.performance[test.name] = result.time;
                    }
                    
                } catch (error) {
                    resultEl.className = 'test-result fail';
                    resultEl.textContent = 'ERROR';
                    testResults.failed++;
                    
                    log(`‚úó ${test.name} error: ${error.message}`, 'critical');
                    testResults.bugs.push({
                        test: test.name,
                        error: error.message,
                        severity: 'CRITICAL',
                        suite: suiteName
                    });
                }
                
                updateStats();
                await sleep(100); // Small delay between tests
            }
        }

        function updateStats() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
            document.getElementById('warning-tests').textContent = testResults.warnings;
        }

        async function runAllTests() {
            // Reset results
            testResults = {
                total: 0,
                passed: 0,
                failed: 0,
                warnings: 0,
                bugs: [],
                performance: {}
            };
            testLog = [];
            
            document.getElementById('test-timestamp').textContent = `Test started: ${new Date().toLocaleString()}`;
            log('Starting comprehensive test suite');
            
            // Load wallet in iframe
            const frame = document.getElementById('wallet-frame');
            frame.style.display = 'block';
            frame.style.position = 'fixed';
            frame.style.top = '-9999px';
            frame.src = '/index.html';
            
            await sleep(3000); // Wait for wallet to load
            
            // Run test suites
            await runTestSuite('seed', testSuites.seed, 'seed-tests');
            await runTestSuite('ui', testSuites.ui, 'ui-tests');
            await runTestSuite('multiWallet', testSuites.multiWallet, 'multi-wallet-tests');
            await runTestSuite('enterprise', testSuites.enterprise, 'enterprise-tests');
            
            // Generate bug report
            generateBugReport();
            
            // Generate performance report
            generatePerformanceReport();
            
            log(`Test suite completed. Passed: ${testResults.passed}, Failed: ${testResults.failed}, Warnings: ${testResults.warnings}`);
        }

        function generateBugReport() {
            const container = document.getElementById('bug-report');
            container.innerHTML = '';
            
            if (testResults.bugs.length === 0) {
                container.innerHTML = '<p style="color: #4caf50;">‚úì No critical bugs found!</p>';
                return;
            }
            
            testResults.bugs.forEach(bug => {
                const bugEl = document.createElement('div');
                bugEl.className = 'bug-report';
                bugEl.innerHTML = `
                    <div><strong>Test:</strong> ${bug.test}</div>
                    <div><strong>Suite:</strong> ${bug.suite}</div>
                    <div><strong>Severity:</strong> <span class="critical">${bug.severity}</span></div>
                    <div><strong>Error:</strong> ${bug.error}</div>
                `;
                container.appendChild(bugEl);
            });
        }

        function generatePerformanceReport() {
            const container = document.getElementById('performance-metrics');
            container.innerHTML = '';
            
            const metrics = Object.entries(testResults.performance);
            if (metrics.length === 0) {
                container.innerHTML = '<p>No performance metrics collected</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.innerHTML = `
                <tr>
                    <th style="text-align: left;">Test</th>
                    <th style="text-align: right;">Time (ms)</th>
                    <th style="text-align: right;">Status</th>
                </tr>
            `;
            
            metrics.forEach(([test, time]) => {
                const row = document.createElement('tr');
                const status = time < 1000 ? 'Good' : time < 5000 ? 'Acceptable' : 'Slow';
                const color = time < 1000 ? '#4caf50' : time < 5000 ? '#ff9800' : '#f44336';
                
                row.innerHTML = `
                    <td>${test}</td>
                    <td style="text-align: right;">${time.toFixed(2)}</td>
                    <td style="text-align: right; color: ${color};">${status}</td>
                `;
                table.appendChild(row);
            });
            
            container.appendChild(table);
        }

        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                results: testResults,
                log: testLog,
                browser: navigator.userAgent
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `moosh-wallet-test-report-${Date.now()}.json`;
            a.click();
        }

        function clearResults() {
            document.getElementById('seed-tests').innerHTML = '';
            document.getElementById('ui-tests').innerHTML = '';
            document.getElementById('multi-wallet-tests').innerHTML = '';
            document.getElementById('enterprise-tests').innerHTML = '';
            document.getElementById('bug-report').innerHTML = '';
            document.getElementById('performance-metrics').innerHTML = '';
            document.getElementById('test-log').innerHTML = '';
            
            testResults = {
                total: 0,
                passed: 0,
                failed: 0,
                warnings: 0,
                bugs: [],
                performance: {}
            };
            
            updateStats();
        }

        // Initialize
        document.getElementById('test-timestamp').textContent = `Ready to test at ${new Date().toLocaleString()}`;
    </script>
</body>
</html>