<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Test - Dashboard Display Fixes</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #f57315;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            border: 1px solid #f57315;
            padding: 20px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #111;
            border-left: 3px solid #f57315;
            font-size: 12px;
        }
        
        .status-ok { border-left-color: #00ff00; color: #00ff00; }
        .status-error { border-left-color: #ff0000; color: #ff0000; }
        .status-info { border-left-color: #f57315; color: #f57315; }
        .status-warning { border-left-color: #ffff00; color: #ffff00; }
        
        button {
            background: #000;
            color: #f57315;
            border: 2px solid #f57315;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s ease;
        }
        
        button:hover {
            background: #f57315;
            color: #000;
        }
        
        .data-display {
            background: #111;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            line-height: 1.6;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .comparison-box {
            border: 1px solid #333;
            padding: 20px;
        }
        
        .comparison-box h3 {
            margin-top: 0;
            color: #ff8c42;
        }
        
        .value-check {
            padding: 5px 10px;
            margin: 5px 0;
            background: #111;
        }
        
        .value-check.pass {
            border-left: 3px solid #00ff00;
        }
        
        .value-check.fail {
            border-left: 3px solid #ff0000;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>[==] DASHBOARD DISPLAY FIX TEST [==]</h1>
            <p>Testing BTC Price & Balance Display</p>
        </div>
        
        <div class="test-section">
            <h2>[>] Test Controls</h2>
            <button onclick="checkDashboard()">Check Dashboard Status</button>
            <button onclick="checkPriceElements()">Check Price Elements</button>
            <button onclick="checkBalanceElements()">Check Balance Elements</button>
            <button onclick="triggerRefresh()">Trigger Refresh</button>
            <button onclick="checkApiResponses()">Check API Responses</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div class="test-section">
            <h2>[>] Current Dashboard Status</h2>
            <div id="dashboard-status" class="data-display">
                <div>BTC Price: <span id="current-price">Not loaded</span></div>
                <div>BTC Balance: <span id="current-balance">Not loaded</span></div>
                <div>USD Value: <span id="current-usd">Not loaded</span></div>
                <div>Update Status: <span id="update-status">Not checked</span></div>
                <div>Last Update: <span id="last-update">Never</span></div>
            </div>
        </div>
        
        <div class="comparison-grid">
            <div class="comparison-box">
                <h3>Expected Values</h3>
                <div class="value-check" id="price-check">
                    <strong>BTC Price:</strong> Should be > $0.00
                </div>
                <div class="value-check" id="balance-check">
                    <strong>Balance:</strong> Should show actual balance
                </div>
                <div class="value-check" id="loading-check">
                    <strong>Initial State:</strong> Should show "Loading..."
                </div>
                <div class="value-check" id="update-check">
                    <strong>Auto Update:</strong> Should update on mount
                </div>
                <div class="value-check" id="interval-check">
                    <strong>Refresh Interval:</strong> Should update every 30s
                </div>
            </div>
            
            <div class="comparison-box">
                <h3>API Responses</h3>
                <div id="api-status">
                    <p>Testing API connections...</p>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>[>] Test Results</h2>
            <div id="test-results"></div>
        </div>
    </div>
    
    <!-- Load MOOSH Wallet -->
    <script src="/public/js/moosh-wallet.js"></script>
    
    <script>
        let app = null;
        let dashboard = null;
        
        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            try {
                app = new MOOSHWallet();
                // Create a test account if none exists
                const accounts = app.state.get('accounts') || [];
                if (accounts.length === 0) {
                    app.state.set('accounts', [{
                        id: 'test-1',
                        name: 'Test Account',
                        addresses: { 
                            bitcoin: 'bc1qtest...',
                            segwit: '3test...',
                            taproot: 'tb1ptest...'
                        },
                        createdAt: Date.now()
                    }]);
                    app.state.set('currentAccountId', 'test-1');
                }
                
                logResult('App initialized', 'ok');
                
                // Navigate to dashboard
                setTimeout(() => {
                    app.router.navigate('dashboard');
                    dashboard = app.router.currentPageInstance;
                    logResult('Dashboard loaded', 'ok');
                    
                    // Check initial status after a short delay
                    setTimeout(() => {
                        checkDashboard();
                    }, 1000);
                }, 500);
                
            } catch (error) {
                logResult('Failed to initialize: ' + error.message, 'error');
            }
        });
        
        function logResult(message, status = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result status-${status}`;
            const timestamp = new Date().toLocaleTimeString();
            const indicator = status === 'ok' ? '[OK]' : status === 'error' ? '[X]' : status === 'warning' ? '[!!]' : '[>]';
            resultDiv.textContent = `${timestamp} ${indicator} ${message}`;
            resultsDiv.appendChild(resultDiv);
            console.log(`${indicator} ${message}`);
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('api-status').innerHTML = '<p>Testing API connections...</p>';
            logResult('Results cleared', 'info');
        }
        
        function checkDashboard() {
            if (!dashboard) {
                logResult('Dashboard not loaded yet', 'error');
                return;
            }
            
            // Check if updateLiveData exists and was called
            if (typeof dashboard.updateLiveData === 'function') {
                logResult('updateLiveData method exists', 'ok');
            } else {
                logResult('updateLiveData method missing', 'error');
            }
            
            // Check if refreshBalances exists
            if (typeof dashboard.refreshBalances === 'function') {
                logResult('refreshBalances method exists', 'ok');
            } else {
                logResult('refreshBalances method missing', 'error');
            }
            
            // Check if intervals are set
            if (dashboard.liveDataInterval) {
                logResult('Live data interval is active', 'ok');
            } else {
                logResult('Live data interval not set', 'warning');
            }
            
            updateDashboardStatus();
        }
        
        function checkPriceElements() {
            const btcPrice = document.getElementById('btcPrice');
            const priceChange = document.getElementById('priceChange');
            
            if (btcPrice) {
                const price = btcPrice.textContent;
                logResult(`BTC price element found: ${price}`, 'info');
                
                if (price && price !== '0.00' && price !== '$0.00') {
                    logResult('BTC price is displaying correctly', 'ok');
                    document.getElementById('price-check').className = 'value-check pass';
                } else {
                    logResult('BTC price showing $0.00', 'error');
                    document.getElementById('price-check').className = 'value-check fail';
                }
            } else {
                logResult('BTC price element not found', 'error');
            }
            
            if (priceChange) {
                logResult(`Price change element found: ${priceChange.textContent}`, 'info');
            }
            
            // Check app state
            const storedPrice = app.state.get('btcPrice');
            if (storedPrice && storedPrice > 0) {
                logResult(`BTC price in state: $${storedPrice}`, 'ok');
            } else {
                logResult('BTC price not stored in state', 'warning');
            }
        }
        
        function checkBalanceElements() {
            const btcBalance = document.getElementById('btc-balance');
            const usdBalance = document.getElementById('usd-balance');
            
            if (btcBalance) {
                const balance = btcBalance.textContent;
                logResult(`BTC balance element found: ${balance}`, 'info');
                
                if (balance === 'Loading...') {
                    logResult('Balance shows loading state correctly', 'ok');
                    document.getElementById('loading-check').className = 'value-check pass';
                } else if (balance && balance !== '0.00000000') {
                    logResult('Balance is displaying actual value', 'ok');
                    document.getElementById('balance-check').className = 'value-check pass';
                } else {
                    logResult('Balance still showing 0.00000000', 'warning');
                    document.getElementById('balance-check').className = 'value-check fail';
                }
            } else {
                logResult('BTC balance element not found', 'error');
            }
            
            if (usdBalance) {
                const usd = usdBalance.textContent;
                logResult(`USD balance element found: ${usd}`, 'info');
            }
            
            updateDashboardStatus();
        }
        
        async function triggerRefresh() {
            if (!dashboard) {
                logResult('Dashboard not loaded', 'error');
                return;
            }
            
            logResult('Triggering dashboard refresh...', 'info');
            
            try {
                if (dashboard.updateLiveData) {
                    await dashboard.updateLiveData();
                    logResult('updateLiveData completed', 'ok');
                    document.getElementById('update-check').className = 'value-check pass';
                }
                
                if (dashboard.refreshBalances) {
                    await dashboard.refreshBalances();
                    logResult('refreshBalances completed', 'ok');
                }
                
                setTimeout(() => {
                    checkPriceElements();
                    checkBalanceElements();
                }, 500);
                
            } catch (error) {
                logResult('Refresh failed: ' + error.message, 'error');
            }
        }
        
        async function checkApiResponses() {
            const apiDiv = document.getElementById('api-status');
            apiDiv.innerHTML = '';
            
            // Test CoinGecko API
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
                const data = await response.json();
                
                const price = data?.bitcoin?.usd || 0;
                const change = data?.bitcoin?.usd_24h_change || 0;
                
                apiDiv.innerHTML += `<div class="value-check pass">
                    <strong>CoinGecko API:</strong> OK<br>
                    BTC: $${price.toLocaleString()}<br>
                    24h: ${change.toFixed(2)}%
                </div>`;
                
                logResult(`CoinGecko API: BTC at $${price}`, 'ok');
                
            } catch (error) {
                apiDiv.innerHTML += `<div class="value-check fail">
                    <strong>CoinGecko API:</strong> Failed<br>
                    ${error.message}
                </div>`;
                logResult('CoinGecko API failed: ' + error.message, 'error');
            }
            
            // Test app's API service
            if (app && app.apiService) {
                try {
                    const priceData = await app.apiService.fetchBitcoinPrice();
                    const price = priceData?.bitcoin?.usd || priceData?.usd || 0;
                    
                    apiDiv.innerHTML += `<div class="value-check pass">
                        <strong>App API Service:</strong> OK<br>
                        Price: $${price}
                    </div>`;
                    
                    logResult(`App API service working: $${price}`, 'ok');
                    
                } catch (error) {
                    apiDiv.innerHTML += `<div class="value-check fail">
                        <strong>App API Service:</strong> Failed<br>
                        ${error.message}
                    </div>`;
                    logResult('App API service failed: ' + error.message, 'error');
                }
            }
        }
        
        function updateDashboardStatus() {
            const btcPrice = document.getElementById('btcPrice')?.textContent || 'Not found';
            const btcBalance = document.getElementById('btc-balance')?.textContent || 'Not found';
            const usdBalance = document.getElementById('usd-balance')?.textContent || 'Not found';
            
            document.getElementById('current-price').textContent = btcPrice;
            document.getElementById('current-balance').textContent = btcBalance;
            document.getElementById('current-usd').textContent = usdBalance;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            
            // Check if intervals are running
            if (dashboard && dashboard.liveDataInterval) {
                document.getElementById('update-status').textContent = 'Auto-updating';
                document.getElementById('update-status').style.color = '#00ff00';
                document.getElementById('interval-check').className = 'value-check pass';
            } else {
                document.getElementById('update-status').textContent = 'Not updating';
                document.getElementById('update-status').style.color = '#ff0000';
                document.getElementById('interval-check').className = 'value-check fail';
            }
        }
        
        // Initial log
        logResult('Dashboard display fix test initialized', 'ok');
    </script>
</body>
</html>