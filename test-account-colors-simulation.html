<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intense User Simulation - Account Colors - MOOSH Wallet</title>
    <link rel="stylesheet" href="css/app.css">
    <style>
        body {
            background: #000;
            color: #fff;
            font-family: 'JetBrains Mono', monospace;
            padding: 20px;
        }
        
        .simulation-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-card {
            background: #111;
            border: 2px solid #333;
            padding: 15px;
        }
        
        .test-card h4 {
            color: #f57315;
            margin-bottom: 10px;
        }
        
        .test-button {
            padding: 8px 16px;
            background: #000;
            border: 2px solid #f57315;
            color: #f57315;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            transition: all 0.2s ease;
            margin: 5px;
            display: block;
            width: 100%;
        }
        
        .test-button:hover {
            background: #f57315;
            color: #000;
        }
        
        .run-all {
            padding: 20px;
            font-size: 18px;
            background: #f57315;
            color: #000;
            margin: 20px 0;
        }
        
        .results {
            background: #000;
            border: 2px solid #333;
            padding: 20px;
            margin: 20px 0;
            white-space: pre-wrap;
            font-size: 11px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .success { color: #69fd97; }
        .error { color: #ff4444; }
        .info { color: #00d4ff; }
        .warning { color: #f57315; }
        
        .test-status {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 11px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .status-pending { background: #333; color: #fff; }
        .status-running { background: #f57315; color: #000; }
        .status-passed { background: #69fd97; color: #000; }
        .status-failed { background: #ff4444; color: #fff; }
        
        .bug-report {
            background: #220000;
            border: 2px solid #ff4444;
            padding: 15px;
            margin: 20px 0;
        }
        
        .fix-report {
            background: #002200;
            border: 2px solid #69fd97;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div class="simulation-container">
        <h1 style="color: #f57315; text-align: center;">INTENSE USER SIMULATION - ACCOUNT COLORS</h1>
        
        <button class="test-button run-all" onclick="runAllSimulations()">RUN ALL SIMULATIONS</button>
        
        <div class="test-grid">
            <div class="test-card">
                <h4>1. Color Assignment Tests</h4>
                <button class="test-button" onclick="testColorAssignment()">Run Test</button>
                <div class="test-status status-pending" id="status-1">PENDING</div>
            </div>
            
            <div class="test-card">
                <h4>2. Color Persistence Tests</h4>
                <button class="test-button" onclick="testColorPersistence()">Run Test</button>
                <div class="test-status status-pending" id="status-2">PENDING</div>
            </div>
            
            <div class="test-card">
                <h4>3. Color Picker Tests</h4>
                <button class="test-button" onclick="testColorPicker()">Run Test</button>
                <div class="test-status status-pending" id="status-3">PENDING</div>
            </div>
            
            <div class="test-card">
                <h4>4. View Mode Tests</h4>
                <button class="test-button" onclick="testViewModes()">Run Test</button>
                <div class="test-status status-pending" id="status-4">PENDING</div>
            </div>
            
            <div class="test-card">
                <h4>5. Edge Case Tests</h4>
                <button class="test-button" onclick="testEdgeCases()">Run Test</button>
                <div class="test-status status-pending" id="status-5">PENDING</div>
            </div>
            
            <div class="test-card">
                <h4>6. Performance Tests</h4>
                <button class="test-button" onclick="testPerformance()">Run Test</button>
                <div class="test-status status-pending" id="status-6">PENDING</div>
            </div>
            
            <div class="test-card">
                <h4>7. Migration Tests</h4>
                <button class="test-button" onclick="testMigration()">Run Test</button>
                <div class="test-status status-pending" id="status-7">PENDING</div>
            </div>
            
            <div class="test-card">
                <h4>8. UI Consistency Tests</h4>
                <button class="test-button" onclick="testUIConsistency()">Run Test</button>
                <div class="test-status status-pending" id="status-8">PENDING</div>
            </div>
            
            <div class="test-card">
                <h4>9. Rapid Actions Test</h4>
                <button class="test-button" onclick="testRapidActions()">Run Test</button>
                <div class="test-status status-pending" id="status-9">PENDING</div>
            </div>
        </div>
        
        <div id="bugReport" class="bug-report" style="display: none;">
            <h3 style="color: #ff4444;">BUGS FOUND</h3>
            <div id="bugList"></div>
        </div>
        
        <div id="fixReport" class="fix-report" style="display: none;">
            <h3 style="color: #69fd97;">FIXES APPLIED</h3>
            <div id="fixList"></div>
        </div>
        
        <div class="results" id="results">
            <span class="info">Ready to run intense simulation tests. Click "RUN ALL SIMULATIONS" to begin.</span>
        </div>
    </div>
    
    <script src="js/moosh-wallet.js"></script>
    <script>
        const results = document.getElementById('results');
        let testLog = [];
        let bugs = [];
        let testsPassed = 0;
        let testsFailed = 0;
        
        function log(message, type = 'info') {
            const time = new Date().toTimeString().split(' ')[0];
            testLog.push(`<span class="${type}">[${time}] ${message}</span>`);
            results.innerHTML = testLog.join('\n');
            results.scrollTop = results.scrollHeight;
        }
        
        function updateStatus(testId, status) {
            const statusEl = document.getElementById(`status-${testId}`);
            statusEl.className = `test-status status-${status}`;
            statusEl.textContent = status.toUpperCase();
        }
        
        function reportBug(bug) {
            bugs.push(bug);
            document.getElementById('bugReport').style.display = 'block';
            document.getElementById('bugList').innerHTML = bugs.map((b, i) => 
                `${i + 1}. ${b}`
            ).join('<br>');
        }
        
        async function testColorAssignment() {
            updateStatus(1, 'running');
            log('\n=== TEST 1: COLOR ASSIGNMENT ===', 'info');
            
            let passed = true;
            
            try {
                // Test 1.1: Check existing accounts have colors
                const accounts = window.app.state.get('accounts') || [];
                log(`Testing ${accounts.length} existing accounts...`, 'info');
                
                accounts.forEach(account => {
                    if (!account.color) {
                        log(`âœ— Account "${account.name}" missing color`, 'error');
                        reportBug(`Account "${account.name}" has no color assigned`);
                        passed = false;
                    } else {
                        log(`âœ“ Account "${account.name}" has color: ${account.color}`, 'success');
                    }
                });
                
                // Test 1.2: Test getNextAccountColor
                const colors = window.app.state.getAccountColors();
                const nextColor = window.app.state.getNextAccountColor();
                
                if (!colors.includes(nextColor)) {
                    log(`âœ— getNextAccountColor returned invalid color: ${nextColor}`, 'error');
                    reportBug(`getNextAccountColor returns color not in palette`);
                    passed = false;
                } else {
                    log(`âœ“ getNextAccountColor returns valid color: ${nextColor}`, 'success');
                }
                
                // Test 1.3: Test color uniqueness for first 8 accounts
                const usedColors = accounts.slice(0, 8).map(acc => acc.color);
                const uniqueColors = [...new Set(usedColors)];
                
                if (usedColors.length <= 8 && uniqueColors.length !== usedColors.length) {
                    log(`âœ— Duplicate colors found in first 8 accounts`, 'error');
                    reportBug(`First 8 accounts should have unique colors`);
                    passed = false;
                } else {
                    log(`âœ“ Color uniqueness maintained`, 'success');
                }
                
            } catch (error) {
                log(`âœ— Error in color assignment test: ${error.message}`, 'error');
                reportBug(`Color assignment error: ${error.message}`);
                passed = false;
            }
            
            updateStatus(1, passed ? 'passed' : 'failed');
            if (passed) testsPassed++; else testsFailed++;
            return passed;
        }
        
        async function testColorPersistence() {
            updateStatus(2, 'running');
            log('\n=== TEST 2: COLOR PERSISTENCE ===', 'info');
            
            let passed = true;
            
            try {
                // Test 2.1: Save current colors
                const accounts = window.app.state.get('accounts') || [];
                const originalColors = accounts.map(acc => ({ id: acc.id, color: acc.color }));
                
                // Test 2.2: Change a color
                if (accounts.length > 0) {
                    const testAccount = accounts[0];
                    const newColor = '#ff8c42';
                    
                    log(`Changing color for "${testAccount.name}" to ${newColor}...`, 'info');
                    window.app.state.updateAccountColor(testAccount.id, newColor);
                    
                    // Test 2.3: Check if persisted
                    const stored = localStorage.getItem('mooshAccounts');
                    if (!stored) {
                        log('âœ— Accounts not found in localStorage', 'error');
                        reportBug('Account persistence to localStorage failed');
                        passed = false;
                    } else {
                        const data = JSON.parse(stored);
                        const storedAccount = data.accounts.find(a => a.id === testAccount.id);
                        
                        if (storedAccount?.color !== newColor) {
                            log(`âœ— Color not persisted correctly`, 'error');
                            reportBug('Color changes not persisting to localStorage');
                            passed = false;
                        } else {
                            log('âœ“ Color persisted to localStorage', 'success');
                        }
                    }
                    
                    // Restore original color
                    window.app.state.updateAccountColor(testAccount.id, originalColors[0].color);
                }
                
            } catch (error) {
                log(`âœ— Error in persistence test: ${error.message}`, 'error');
                reportBug(`Persistence error: ${error.message}`);
                passed = false;
            }
            
            updateStatus(2, passed ? 'passed' : 'failed');
            if (passed) testsPassed++; else testsFailed++;
            return passed;
        }
        
        async function testColorPicker() {
            updateStatus(3, 'running');
            log('\n=== TEST 3: COLOR PICKER ===', 'info');
            
            let passed = true;
            
            try {
                // Open account manager
                const modal = new AccountListModal(window.app);
                modal.show();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const modalEl = document.querySelector('.account-list-modal');
                if (!modalEl) {
                    log('âœ— Account manager failed to open', 'error');
                    reportBug('AccountListModal not opening');
                    passed = false;
                    updateStatus(3, 'failed');
                    return false;
                }
                
                // Test 3.1: Check COLOR buttons exist
                const colorButtons = Array.from(modalEl.querySelectorAll('button')).filter(
                    btn => btn.textContent === 'COLOR'
                );
                
                if (colorButtons.length === 0) {
                    log('âœ— No COLOR buttons found', 'error');
                    reportBug('COLOR buttons missing from account cards');
                    passed = false;
                } else {
                    log(`âœ“ Found ${colorButtons.length} COLOR buttons`, 'success');
                    
                    // Test 3.2: Click COLOR button
                    colorButtons[0].click();
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    const colorPicker = document.querySelector('[style*="position: fixed"]');
                    if (!colorPicker) {
                        log('âœ— Color picker overlay not opening', 'error');
                        reportBug('showColorPicker() not creating overlay');
                        passed = false;
                    } else {
                        log('âœ“ Color picker overlay opened', 'success');
                        
                        // Test 3.3: Check color options
                        const colorOptions = colorPicker.querySelectorAll('button[style*="width: 60px"]');
                        const expectedColors = window.app.state.getAccountColors().length;
                        
                        if (colorOptions.length !== expectedColors) {
                            log(`âœ— Expected ${expectedColors} colors, found ${colorOptions.length}`, 'error');
                            reportBug('Color picker not showing all color options');
                            passed = false;
                        } else {
                            log(`âœ“ All ${colorOptions.length} color options present`, 'success');
                        }
                        
                        // Test 3.4: Click a color
                        if (colorOptions.length > 1) {
                            const accountsBefore = window.app.state.get('accounts')[0].color;
                            colorOptions[1].click();
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            const accountsAfter = window.app.state.get('accounts')[0].color;
                            if (accountsBefore === accountsAfter) {
                                log('âœ— Color not changing when clicked', 'error');
                                reportBug('Color picker clicks not updating account color');
                                passed = false;
                            } else {
                                log('âœ“ Color successfully changed', 'success');
                            }
                        }
                        
                        // Close picker if still open
                        const picker = document.querySelector('[style*="position: fixed"]');
                        if (picker) picker.click();
                    }
                }
                
                // Close modal
                const closeBtn = modalEl.querySelector('button[onclick*="close"]');
                if (closeBtn) closeBtn.click();
                
            } catch (error) {
                log(`âœ— Error in color picker test: ${error.message}`, 'error');
                reportBug(`Color picker error: ${error.message}`);
                passed = false;
            }
            
            updateStatus(3, passed ? 'passed' : 'failed');
            if (passed) testsPassed++; else testsFailed++;
            return passed;
        }
        
        async function testViewModes() {
            updateStatus(4, 'running');
            log('\n=== TEST 4: VIEW MODES ===', 'info');
            
            let passed = true;
            
            try {
                const modal = new AccountListModal(window.app);
                modal.show();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const modalEl = document.querySelector('.account-list-modal');
                if (!modalEl) {
                    passed = false;
                    updateStatus(4, 'failed');
                    return false;
                }
                
                const viewModes = ['GRID', 'LIST', 'DETAILS'];
                
                for (const mode of viewModes) {
                    log(`Testing ${mode} view...`, 'info');
                    
                    const viewBtn = Array.from(modalEl.querySelectorAll('button')).find(
                        btn => btn.textContent === mode
                    );
                    
                    if (!viewBtn) {
                        log(`âœ— ${mode} button not found`, 'error');
                        reportBug(`${mode} view button missing`);
                        passed = false;
                        continue;
                    }
                    
                    viewBtn.click();
                    await new Promise(resolve => setTimeout(resolve, 300));
                    
                    const accountGrid = modalEl.querySelector('.account-grid');
                    if (!accountGrid) {
                        log(`âœ— ${mode} view not rendering`, 'error');
                        reportBug(`${mode} view not creating .account-grid element`);
                        passed = false;
                    } else {
                        // Check for colored borders
                        const coloredElements = accountGrid.querySelectorAll('[style*="borderLeft"]');
                        if (coloredElements.length === 0) {
                            log(`âœ— ${mode} view missing color borders`, 'error');
                            reportBug(`${mode} view not showing colored borders`);
                            passed = false;
                        } else {
                            log(`âœ“ ${mode} view showing ${coloredElements.length} colored borders`, 'success');
                        }
                    }
                }
                
                const closeBtn = modalEl.querySelector('button[onclick*="close"]');
                if (closeBtn) closeBtn.click();
                
            } catch (error) {
                log(`âœ— Error in view modes test: ${error.message}`, 'error');
                reportBug(`View modes error: ${error.message}`);
                passed = false;
            }
            
            updateStatus(4, passed ? 'passed' : 'failed');
            if (passed) testsPassed++; else testsFailed++;
            return passed;
        }
        
        async function testEdgeCases() {
            updateStatus(5, 'running');
            log('\n=== TEST 5: EDGE CASES ===', 'info');
            
            let passed = true;
            
            try {
                // Test 5.1: No accounts
                const originalAccounts = window.app.state.get('accounts');
                window.app.state.set('accounts', []);
                
                const emptyNextColor = window.app.state.getNextAccountColor();
                if (!emptyNextColor) {
                    log('âœ— getNextAccountColor fails with no accounts', 'error');
                    reportBug('getNextAccountColor returns null when no accounts');
                    passed = false;
                } else {
                    log('âœ“ getNextAccountColor works with no accounts', 'success');
                }
                
                // Restore accounts
                window.app.state.set('accounts', originalAccounts);
                
                // Test 5.2: More than 8 accounts (color reuse)
                if (originalAccounts.length > 8) {
                    const colors = originalAccounts.map(acc => acc.color);
                    const colorCounts = {};
                    colors.forEach(color => {
                        colorCounts[color] = (colorCounts[color] || 0) + 1;
                    });
                    
                    const reusedColors = Object.entries(colorCounts).filter(([_, count]) => count > 1);
                    if (reusedColors.length > 0) {
                        log(`âœ“ Colors correctly reused for >8 accounts`, 'success');
                    }
                }
                
                // Test 5.3: Invalid color update
                if (originalAccounts.length > 0) {
                    const result = window.app.state.updateAccountColor('invalid-id', '#ffffff');
                    if (result !== false) {
                        log('âœ— updateAccountColor should return false for invalid ID', 'error');
                        reportBug('updateAccountColor not validating account ID');
                        passed = false;
                    } else {
                        log('âœ“ updateAccountColor correctly rejects invalid ID', 'success');
                    }
                }
                
            } catch (error) {
                log(`âœ— Error in edge cases test: ${error.message}`, 'error');
                reportBug(`Edge case error: ${error.message}`);
                passed = false;
            }
            
            updateStatus(5, passed ? 'passed' : 'failed');
            if (passed) testsPassed++; else testsFailed++;
            return passed;
        }
        
        async function testPerformance() {
            updateStatus(6, 'running');
            log('\n=== TEST 6: PERFORMANCE ===', 'info');
            
            let passed = true;
            
            try {
                // Test 6.1: Color assignment performance
                const start = performance.now();
                for (let i = 0; i < 100; i++) {
                    window.app.state.getNextAccountColor();
                }
                const assignTime = performance.now() - start;
                
                if (assignTime > 50) {
                    log(`âœ— Color assignment too slow: ${assignTime.toFixed(2)}ms for 100 calls`, 'error');
                    reportBug('getNextAccountColor performance issue');
                    passed = false;
                } else {
                    log(`âœ“ Color assignment fast: ${assignTime.toFixed(2)}ms for 100 calls`, 'success');
                }
                
                // Test 6.2: UI update performance
                const modal = new AccountListModal(window.app);
                modal.show();
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const updateStart = performance.now();
                modal.updateAccountGrid();
                const updateTime = performance.now() - updateStart;
                
                if (updateTime > 100) {
                    log(`âœ— Grid update too slow: ${updateTime.toFixed(2)}ms`, 'error');
                    reportBug('updateAccountGrid performance issue');
                    passed = false;
                } else {
                    log(`âœ“ Grid update fast: ${updateTime.toFixed(2)}ms`, 'success');
                }
                
                const closeBtn = document.querySelector('.account-list-modal button[onclick*="close"]');
                if (closeBtn) closeBtn.click();
                
            } catch (error) {
                log(`âœ— Error in performance test: ${error.message}`, 'error');
                reportBug(`Performance test error: ${error.message}`);
                passed = false;
            }
            
            updateStatus(6, passed ? 'passed' : 'failed');
            if (passed) testsPassed++; else testsFailed++;
            return passed;
        }
        
        async function testMigration() {
            updateStatus(7, 'running');
            log('\n=== TEST 7: MIGRATION ===', 'info');
            
            let passed = true;
            
            try {
                // Test 7.1: Simulate old account without color
                const accounts = window.app.state.get('accounts');
                if (accounts.length > 0) {
                    // Save current state
                    const backup = JSON.parse(localStorage.getItem('mooshAccounts'));
                    
                    // Create account without color
                    const testData = {
                        accounts: [{
                            id: 'test-migration',
                            name: 'Legacy Account',
                            addresses: { segwit: 'bc1qtest' },
                            createdAt: Date.now()
                            // No color field
                        }],
                        currentAccountId: 'test-migration'
                    };
                    
                    localStorage.setItem('mooshAccounts', JSON.stringify(testData));
                    
                    // Reload accounts
                    window.app.state.loadAccounts();
                    
                    // Check if color was added
                    const migratedAccount = window.app.state.get('accounts').find(a => a.id === 'test-migration');
                    if (!migratedAccount?.color) {
                        log('âœ— Migration failed to add color to legacy account', 'error');
                        reportBug('Account migration not adding colors');
                        passed = false;
                    } else {
                        log(`âœ“ Legacy account migrated with color: ${migratedAccount.color}`, 'success');
                    }
                    
                    // Restore original accounts
                    localStorage.setItem('mooshAccounts', JSON.stringify(backup));
                    window.app.state.loadAccounts();
                }
                
            } catch (error) {
                log(`âœ— Error in migration test: ${error.message}`, 'error');
                reportBug(`Migration error: ${error.message}`);
                passed = false;
            }
            
            updateStatus(7, passed ? 'passed' : 'failed');
            if (passed) testsPassed++; else testsFailed++;
            return passed;
        }
        
        async function testUIConsistency() {
            updateStatus(8, 'running');
            log('\n=== TEST 8: UI CONSISTENCY ===', 'info');
            
            let passed = true;
            
            try {
                const modal = new AccountListModal(window.app);
                modal.show();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const modalEl = document.querySelector('.account-list-modal');
                if (!modalEl) {
                    passed = false;
                    updateStatus(8, 'failed');
                    return false;
                }
                
                // Test 8.1: Check hover effects
                const accountCards = modalEl.querySelectorAll('.account-card, [style*="display: flex"][style*="alignItems: center"]');
                
                if (accountCards.length === 0) {
                    log('âœ— No account elements found', 'error');
                    reportBug('Account elements not rendering');
                    passed = false;
                } else {
                    // Simulate hover
                    const firstCard = accountCards[0];
                    const originalBg = firstCard.style.background;
                    
                    firstCard.dispatchEvent(new MouseEvent('mouseover', { bubbles: true }));
                    const hoverBg = firstCard.style.background;
                    
                    if (originalBg === hoverBg) {
                        log('âœ— Hover effects not working', 'error');
                        reportBug('Account hover effects not applying');
                        passed = false;
                    } else {
                        log('âœ“ Hover effects working', 'success');
                    }
                    
                    firstCard.dispatchEvent(new MouseEvent('mouseout', { bubbles: true }));
                }
                
                // Test 8.2: Check active account styling
                const activeElements = modalEl.querySelectorAll('[style*="ACTIVE ACCOUNT"]');
                const currentAccountId = window.app.state.get('currentAccountId');
                const activeAccount = window.app.state.get('accounts').find(a => a.id === currentAccountId);
                
                if (activeAccount && activeElements.length === 0) {
                    log('âœ— Active account indicator missing', 'error');
                    reportBug('Active account not showing ACTIVE ACCOUNT banner');
                    passed = false;
                } else if (activeAccount) {
                    log('âœ“ Active account properly indicated', 'success');
                }
                
                const closeBtn = modalEl.querySelector('button[onclick*="close"]');
                if (closeBtn) closeBtn.click();
                
            } catch (error) {
                log(`âœ— Error in UI consistency test: ${error.message}`, 'error');
                reportBug(`UI consistency error: ${error.message}`);
                passed = false;
            }
            
            updateStatus(8, passed ? 'passed' : 'failed');
            if (passed) testsPassed++; else testsFailed++;
            return passed;
        }
        
        async function testRapidActions() {
            updateStatus(9, 'running');
            log('\n=== TEST 9: RAPID ACTIONS ===', 'info');
            
            let passed = true;
            
            try {
                const modal = new AccountListModal(window.app);
                modal.show();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const modalEl = document.querySelector('.account-list-modal');
                if (!modalEl) {
                    passed = false;
                    updateStatus(9, 'failed');
                    return false;
                }
                
                // Test 9.1: Rapid view switching
                const viewButtons = ['GRID', 'LIST', 'DETAILS'].map(mode =>
                    Array.from(modalEl.querySelectorAll('button')).find(btn => btn.textContent === mode)
                ).filter(Boolean);
                
                log('Testing rapid view switching...', 'info');
                for (let i = 0; i < 10; i++) {
                    viewButtons[i % viewButtons.length].click();
                }
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const gridAfterRapid = modalEl.querySelector('.account-grid');
                if (!gridAfterRapid) {
                    log('âœ— View broke after rapid switching', 'error');
                    reportBug('Rapid view switching causes render failure');
                    passed = false;
                } else {
                    log('âœ“ Views stable after rapid switching', 'success');
                }
                
                // Test 9.2: Rapid color picker open/close
                const colorButtons = Array.from(modalEl.querySelectorAll('button')).filter(
                    btn => btn.textContent === 'COLOR'
                );
                
                if (colorButtons.length > 0) {
                    log('Testing rapid color picker open/close...', 'info');
                    
                    for (let i = 0; i < 5; i++) {
                        colorButtons[0].click();
                        await new Promise(resolve => setTimeout(resolve, 50));
                        
                        const picker = document.querySelector('[style*="position: fixed"]');
                        if (picker) picker.click(); // Close by clicking overlay
                        await new Promise(resolve => setTimeout(resolve, 50));
                    }
                    
                    // Check if UI still responsive
                    const finalColorBtn = Array.from(modalEl.querySelectorAll('button')).find(
                        btn => btn.textContent === 'COLOR'
                    );
                    
                    if (!finalColorBtn) {
                        log('âœ— COLOR buttons disappeared after rapid use', 'error');
                        reportBug('Rapid color picker use breaks UI');
                        passed = false;
                    } else {
                        log('âœ“ UI stable after rapid color picker use', 'success');
                    }
                }
                
                const closeBtn = modalEl.querySelector('button[onclick*="close"]');
                if (closeBtn) closeBtn.click();
                
            } catch (error) {
                log(`âœ— Error in rapid actions test: ${error.message}`, 'error');
                reportBug(`Rapid actions error: ${error.message}`);
                passed = false;
            }
            
            updateStatus(9, passed ? 'passed' : 'failed');
            if (passed) testsPassed++; else testsFailed++;
            return passed;
        }
        
        async function runAllSimulations() {
            bugs = [];
            testsPassed = 0;
            testsFailed = 0;
            testLog = [];
            
            log('=== STARTING INTENSE USER SIMULATION ===\n', 'info');
            log(`Testing account colors feature with ${window.app.state.get('accounts')?.length || 0} accounts`, 'info');
            
            // Reset all statuses
            for (let i = 1; i <= 9; i++) {
                updateStatus(i, 'pending');
            }
            
            // Run all tests
            await testColorAssignment();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testColorPersistence();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testColorPicker();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testViewModes();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testEdgeCases();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testPerformance();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testMigration();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testUIConsistency();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testRapidActions();
            
            // Summary
            log('\n=== SIMULATION COMPLETE ===', 'info');
            log(`Tests Passed: ${testsPassed}`, 'success');
            log(`Tests Failed: ${testsFailed}`, testsFailed > 0 ? 'error' : 'info');
            
            if (bugs.length === 0) {
                log('\nðŸŽ‰ NO BUGS FOUND! Account colors feature is working perfectly!', 'success');
                document.getElementById('bugReport').style.display = 'none';
            } else {
                log(`\nâš ï¸ Found ${bugs.length} bugs that need fixing`, 'warning');
            }
        }
        
        // Auto-load on page ready
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('Intense simulation ready. Click "RUN ALL SIMULATIONS" to begin.', 'info');
            }, 500);
        });
    </script>
</body>
</html>