<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH - BTC Price Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #f57315;
            margin: 0;
            padding: 20px;
        }

        .test-section {
            background: #111;
            border: 1px solid #f57315;
            padding: 20px;
            margin: 20px 0;
        }

        .price-display {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        button {
            background: #f57315;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
            margin: 5px;
        }

        button:hover {
            background: #ff8c42;
        }

        .log {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            margin: 10px 0;
            height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }

        .status {
            padding: 5px 10px;
            margin: 5px;
            display: inline-block;
        }

        .status-loading {
            background: #333;
            color: #faa307;
        }

        .status-success {
            background: #1a1a1a;
            color: #00ff00;
        }

        .status-error {
            background: #1a1a1a;
            color: #ff0000;
        }
    </style>
</head>
<body>
    <h1>[=] MOOSH BTC Price Test [=]</h1>

    <div class="test-section">
        <h2>[>] Current BTC Price</h2>
        <div class="price-display" id="btc-price">Loading...</div>
        <div id="price-status" class="status status-loading">Fetching price data...</div>
        <button onclick="fetchBTCPrice()">[$] Refresh Price</button>
        <button onclick="simulateDashboard()">[$] Simulate Dashboard Init</button>
    </div>

    <div class="test-section">
        <h2>[*] Dashboard State</h2>
        <div id="dashboard-state">
            <p>BTC Price in State: <span id="state-price">N/A</span></p>
            <p>Price History Length: <span id="history-length">0</span></p>
            <p>Last Update: <span id="last-update">Never</span></p>
        </div>
    </div>

    <div class="test-section">
        <h2>[#] Test Log</h2>
        <div class="log" id="test-log"></div>
    </div>

    <script>
        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logDiv = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#f57315';
            logEntry.textContent = `${timestamp} [${type.toUpperCase()}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message, type);
        }

        // Simulate the state management
        const mockState = {
            btcPrice: 0,
            btcPriceHistory: [],
            dashboardCurrency: 'USD'
        };

        // Mock API service
        const mockAPIService = {
            async fetchBitcoinPrice() {
                log('Fetching BTC price from CoinGecko API...');
                try {
                    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true');
                    const data = await response.json();
                    log('API Response received', 'success');
                    return data;
                } catch (error) {
                    log('API fetch failed: ' + error.message, 'error');
                    throw error;
                }
            }
        };

        // Fetch and display BTC price
        async function fetchBTCPrice() {
            const priceDiv = document.getElementById('btc-price');
            const statusDiv = document.getElementById('price-status');
            
            statusDiv.className = 'status status-loading';
            statusDiv.textContent = 'Fetching price data...';
            
            try {
                const priceData = await mockAPIService.fetchBitcoinPrice();
                const btcPrice = priceData?.bitcoin?.usd || 0;
                const priceChange = priceData?.bitcoin?.usd_24h_change || 0;
                
                // Update display
                priceDiv.textContent = `$${btcPrice.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
                
                // Update status
                statusDiv.className = 'status status-success';
                statusDiv.textContent = `Success! 24h change: ${priceChange >= 0 ? '+' : ''}${priceChange.toFixed(2)}%`;
                
                // Update mock state
                mockState.btcPrice = btcPrice;
                mockState.btcPriceHistory.push({
                    price: btcPrice,
                    timestamp: Date.now()
                });
                
                updateStateDisplay();
                
                log(`BTC Price fetched: $${btcPrice.toFixed(2)}`, 'success');
                
            } catch (error) {
                priceDiv.textContent = 'Error fetching price';
                statusDiv.className = 'status status-error';
                statusDiv.textContent = 'Failed to fetch price';
                log('Failed to fetch BTC price', 'error');
            }
        }

        // Simulate dashboard initialization
        async function simulateDashboard() {
            log('Simulating Dashboard initialization...');
            
            // Simulate the 500ms delay in initializeDashboard
            log('Waiting 500ms before fetching price (simulating dashboard init delay)...');
            
            setTimeout(async () => {
                log('Starting initial BTC price fetch...');
                
                try {
                    const priceData = await mockAPIService.fetchBitcoinPrice();
                    const btcPrice = priceData?.bitcoin?.usd || priceData?.usd || 0;
                    
                    // Store the price in mock state
                    mockState.btcPrice = btcPrice;
                    mockState.btcPriceHistory.push({
                        price: btcPrice,
                        timestamp: Date.now()
                    });
                    
                    log(`Initial BTC price fetched: $${btcPrice}`, 'success');
                    
                    // Update displays
                    document.getElementById('btc-price').textContent = `$${btcPrice.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}`;
                    
                    updateStateDisplay();
                    
                    // Simulate starting live updates
                    log('Starting live data updates (every 30 seconds)...');
                    
                } catch (error) {
                    log('Failed to fetch initial BTC price: ' + error.message, 'error');
                    mockState.btcPrice = 0;
                }
                
            }, 500);
        }

        // Update state display
        function updateStateDisplay() {
            document.getElementById('state-price').textContent = mockState.btcPrice > 0 ? 
                `$${mockState.btcPrice.toFixed(2)}` : 'Not set';
            document.getElementById('history-length').textContent = mockState.btcPriceHistory.length;
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        }

        // Test on load
        window.addEventListener('load', () => {
            log('Page loaded, ready for testing');
            log('Click "Simulate Dashboard Init" to test the initialization flow');
        });
    </script>
</body>
</html>