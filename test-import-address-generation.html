<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOOSH Test - Import Address Generation</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #f57315;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            border: 1px solid #f57315;
            padding: 20px;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            background: #111;
            border-left: 3px solid #f57315;
            font-size: 12px;
            word-break: break-all;
        }
        
        .status-ok { border-left-color: #00ff00; color: #00ff00; }
        .status-error { border-left-color: #ff0000; color: #ff0000; }
        .status-info { border-left-color: #f57315; color: #f57315; }
        .status-warning { border-left-color: #ffff00; color: #ffff00; }
        
        button {
            background: #f57315;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #ff8c42;
        }
        
        textarea {
            width: 100%;
            height: 100px;
            background: #111;
            color: #f57315;
            border: 1px solid #f57315;
            padding: 10px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        
        .address-display {
            background: #111;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #333;
            font-size: 11px;
        }
        
        .address-display span {
            color: #69fd97;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .test-column {
            border: 1px solid #333;
            padding: 15px;
        }
        
        .test-column h3 {
            color: #ff8c42;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>[==] IMPORT ADDRESS GENERATION TEST [==]</h1>
            <p>Testing address generation when importing wallets</p>
        </div>
        
        <div class="test-section">
            <h2>[>] Test Controls</h2>
            <p>Enter a seed phrase to test import functionality:</p>
            <textarea id="testSeed" placeholder="Enter 12 or 24 word seed phrase...">abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about</textarea>
            <div>
                <button onclick="testDirectImport()">Test Direct Import</button>
                <button onclick="testAPIImport()">Test API Import</button>
                <button onclick="testUIImport()">Test UI Import Flow</button>
                <button onclick="testKnownSeed()">Test Known Seed</button>
                <button onclick="clearResults()">Clear Results</button>
            </div>
        </div>
        
        <div class="test-grid">
            <div class="test-column">
                <h3>[>] Expected Addresses</h3>
                <div id="expected-addresses"></div>
            </div>
            
            <div class="test-column">
                <h3>[>] Actual Addresses</h3>
                <div id="actual-addresses"></div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>[>] Test Results</h2>
            <div id="test-results"></div>
        </div>
        
        <div class="test-section">
            <h2>[>] Account State</h2>
            <div id="account-state"></div>
        </div>
    </div>
    
    <!-- Load MOOSH Wallet -->
    <script src="/public/js/moosh-wallet.js"></script>
    
    <script>
        let app = null;
        
        // Test utilities
        function logResult(message, status = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result status-${status}`;
            const timestamp = new Date().toLocaleTimeString();
            const indicator = status === 'ok' ? '[OK]' : status === 'error' ? '[X]' : status === 'warning' ? '[!!]' : '[>]';
            resultDiv.textContent = `${timestamp} ${indicator} ${message}`;
            resultsDiv.appendChild(resultDiv);
            console.log(`${indicator} ${message}`);
        }
        
        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('expected-addresses').innerHTML = '';
            document.getElementById('actual-addresses').innerHTML = '';
            document.getElementById('account-state').innerHTML = '';
            logResult('Results cleared', 'info');
        }
        
        function displayAddresses(addresses, containerId, label) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<h4>${label}</h4>`;
            
            if (!addresses) {
                container.innerHTML += '<p class="status-error">No addresses found</p>';
                return;
            }
            
            const addressTypes = ['spark', 'segwit', 'taproot', 'legacy', 'nestedSegwit', 'bitcoin'];
            
            addressTypes.forEach(type => {
                if (addresses[type]) {
                    const div = document.createElement('div');
                    div.className = 'address-display';
                    div.innerHTML = `<strong>${type}:</strong> <span>${addresses[type]}</span>`;
                    container.appendChild(div);
                }
            });
        }
        
        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            try {
                app = new MOOSHWallet();
                logResult('MOOSH Wallet initialized', 'ok');
                
                // Clear any existing accounts for clean testing
                app.state.set('accounts', []);
                logResult('Cleared existing accounts', 'info');
            } catch (error) {
                logResult('Failed to initialize: ' + error.message, 'error');
            }
        });
        
        // Test direct API import
        async function testDirectImport() {
            const seed = document.getElementById('testSeed').value.trim();
            
            if (!seed) {
                logResult('Please enter a seed phrase', 'error');
                return;
            }
            
            logResult('Testing direct API import...', 'info');
            
            try {
                // Test Bitcoin import
                const bitcoinResponse = await fetch('http://localhost:3001/api/wallet/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mnemonic: seed })
                });
                
                const bitcoinResult = await bitcoinResponse.json();
                
                if (!bitcoinResult.success) {
                    logResult('Bitcoin import failed: ' + bitcoinResult.error, 'error');
                    return;
                }
                
                // Test Spark import
                const sparkResponse = await fetch('http://localhost:3001/api/spark/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mnemonic: seed })
                });
                
                const sparkResult = await sparkResponse.json();
                
                if (!sparkResult.success) {
                    logResult('Spark import failed: ' + sparkResult.error, 'error');
                    return;
                }
                
                logResult('API imports successful', 'ok');
                
                // Display addresses
                const combinedAddresses = {
                    spark: sparkResult.data?.addresses?.spark || sparkResult.data?.spark?.address,
                    segwit: bitcoinResult.data?.bitcoin?.addresses?.segwit,
                    taproot: bitcoinResult.data?.bitcoin?.addresses?.taproot,
                    legacy: bitcoinResult.data?.bitcoin?.addresses?.legacy,
                    nestedSegwit: bitcoinResult.data?.bitcoin?.addresses?.nestedSegwit
                };
                
                displayAddresses(combinedAddresses, 'expected-addresses', 'API Response');
                
                // Log full response for debugging
                logResult('Bitcoin addresses: ' + JSON.stringify(bitcoinResult.data?.bitcoin?.addresses || {}), 'info');
                logResult('Spark address: ' + (sparkResult.data?.addresses?.spark || sparkResult.data?.spark?.address || 'NOT FOUND'), 'info');
                
            } catch (error) {
                logResult('API test failed: ' + error.message, 'error');
            }
        }
        
        // Test API import through StateManager
        async function testAPIImport() {
            const seed = document.getElementById('testSeed').value.trim();
            
            if (!seed || !app) {
                logResult('Please enter a seed phrase and ensure app is initialized', 'error');
                return;
            }
            
            logResult('Testing import through StateManager...', 'info');
            
            try {
                // Create account through StateManager
                await app.state.createAccount('Test Import Account', seed, true);
                
                logResult('Account created successfully', 'ok');
                
                // Get the created account
                const accounts = app.state.getAccounts();
                const latestAccount = accounts[accounts.length - 1];
                
                if (!latestAccount) {
                    logResult('No account found after creation', 'error');
                    return;
                }
                
                displayAddresses(latestAccount.addresses, 'actual-addresses', 'StateManager Account');
                
                // Display account state
                const stateDiv = document.getElementById('account-state');
                stateDiv.innerHTML = `
                    <h4>Account Details:</h4>
                    <div class="address-display">
                        <strong>ID:</strong> ${latestAccount.id}<br>
                        <strong>Name:</strong> ${latestAccount.name}<br>
                        <strong>Type:</strong> ${latestAccount.type}<br>
                        <strong>Wallet Type:</strong> ${latestAccount.walletType}<br>
                        <strong>Created:</strong> ${new Date(latestAccount.createdAt).toLocaleString()}
                    </div>
                `;
                
                // Check for missing addresses
                const addressTypes = ['spark', 'segwit', 'taproot', 'legacy', 'nestedSegwit'];
                const missingAddresses = addressTypes.filter(type => !latestAccount.addresses[type]);
                
                if (missingAddresses.length > 0) {
                    logResult('Missing addresses: ' + missingAddresses.join(', '), 'warning');
                } else {
                    logResult('All address types generated successfully', 'ok');
                }
                
            } catch (error) {
                logResult('StateManager test failed: ' + error.message, 'error');
                console.error('Full error:', error);
            }
        }
        
        // Test UI import flow
        async function testUIImport() {
            if (!app) {
                logResult('App not initialized', 'error');
                return;
            }
            
            logResult('Opening MultiAccountModal for import...', 'info');
            
            try {
                // Create and show the modal
                const modal = new MultiAccountModal(app);
                modal.isImporting = true;
                modal.show();
                
                logResult('Import modal opened - please complete the import manually', 'info');
                logResult('After import, check the account list to verify addresses', 'info');
                
                // Listen for account changes
                const checkInterval = setInterval(() => {
                    const accounts = app.state.getAccounts();
                    if (accounts.length > 0) {
                        clearInterval(checkInterval);
                        const latestAccount = accounts[accounts.length - 1];
                        logResult('New account detected: ' + latestAccount.name, 'ok');
                        displayAddresses(latestAccount.addresses, 'actual-addresses', 'UI Import Result');
                    }
                }, 1000);
                
                // Stop checking after 30 seconds
                setTimeout(() => clearInterval(checkInterval), 30000);
                
            } catch (error) {
                logResult('UI test failed: ' + error.message, 'error');
            }
        }
        
        // Test with known seed
        function testKnownSeed() {
            // Use the test seed from BIP39
            const knownSeed = 'abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about';
            
            // Expected addresses for this seed (from BIP39 test vectors)
            const expectedAddresses = {
                segwit: 'bc1qcr8te4kr609gcawutmrza0j4xv80jy8z306fyu',
                taproot: 'bc1p5d7rjq7g6xgmyvlcn3p78j0xvqtada8ec2hspyckc3gftm3r2pssv5hr29',
                legacy: '1LqBGSgq1KeuEp4jqKhN6M3aWRwfGe7M4K',
                nestedSegwit: '37VucYSd9AaGBJKR1GJhKZnfvRRTinTGo3'
            };
            
            document.getElementById('testSeed').value = knownSeed;
            
            displayAddresses(expectedAddresses, 'expected-addresses', 'Known Test Addresses');
            
            logResult('Loaded known test seed', 'ok');
            logResult('Click "Test API Import" to verify address generation', 'info');
        }
        
        // Initial log
        logResult('Import address generation test initialized', 'ok');
        logResult('API server should be running on port 3001', 'info');
    </script>
</body>
</html>