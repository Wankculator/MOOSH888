<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Multi-Account Initialization</title>
</head>
<body>
    <h1>Multi-Account Initialization Test</h1>
    <button onclick="testWalletGeneration()">Test Wallet Generation Flow</button>
    <button onclick="checkAccounts()">Check Current Accounts</button>
    <button onclick="clearData()">Clear All Data</button>
    <div id="output" style="margin-top: 20px; padding: 20px; border: 1px solid #ccc; font-family: monospace; white-space: pre-wrap;"></div>

    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            output.textContent += message + '\n';
            console.log(message);
        }

        async function testWalletGeneration() {
            output.textContent = '';
            log('Starting wallet generation test...\n');
            
            // Generate a wallet
            log('1. Generating wallet via API...');
            try {
                const response = await fetch('http://localhost:3001/api/spark/generate-wallet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ strength: 128 })
                });
                
                const result = await response.json();
                if (result.success) {
                    log('✓ Wallet generated successfully');
                    log('  Mnemonic: ' + result.data.mnemonic.split(' ').slice(0, 3).join(' ') + '...');
                    log('  Spark address: ' + result.data.addresses.spark);
                    
                    // Store in localStorage like the app does
                    localStorage.setItem('generatedSeed', JSON.stringify(result.data.mnemonic.split(' ')));
                    localStorage.setItem('sparkWallet', JSON.stringify({
                        addresses: result.data.addresses,
                        privateKeys: result.data.privateKeys
                    }));
                    
                    log('\n2. Wallet data stored in localStorage');
                    log('\n3. Now navigate to the app and click "Open Wallet Dashboard"');
                    log('   This should create the first account automatically');
                } else {
                    log('✗ Failed to generate wallet: ' + result.error);
                }
            } catch (error) {
                log('✗ Error generating wallet: ' + error.message);
            }
        }
        
        function checkAccounts() {
            output.textContent = '';
            log('Checking current account state...\n');
            
            const accounts = localStorage.getItem('mooshAccounts');
            const currentId = localStorage.getItem('currentAccountId');
            const sparkWallet = localStorage.getItem('sparkWallet');
            const generatedSeed = localStorage.getItem('generatedSeed');
            
            log('LocalStorage contents:');
            log('- generatedSeed: ' + (generatedSeed ? 'Present' : 'Not found'));
            log('- sparkWallet: ' + (sparkWallet ? 'Present' : 'Not found'));
            log('- mooshAccounts: ' + (accounts ? accounts : 'Not found'));
            log('- currentAccountId: ' + (currentId || 'Not set'));
            
            if (accounts) {
                try {
                    const parsed = JSON.parse(accounts);
                    log('\nAccounts found: ' + parsed.length);
                    parsed.forEach((acc, i) => {
                        log(`\nAccount ${i + 1}:`);
                        log('  ID: ' + acc.id);
                        log('  Name: ' + acc.name);
                        log('  Created: ' + new Date(acc.createdAt).toLocaleString());
                        log('  Is Import: ' + acc.isImport);
                        log('  Spark Address: ' + acc.addresses.spark);
                    });
                } catch (e) {
                    log('Error parsing accounts: ' + e.message);
                }
            }
        }
        
        function clearData() {
            if (confirm('This will clear all wallet data. Are you sure?')) {
                localStorage.removeItem('mooshAccounts');
                localStorage.removeItem('currentAccountId');
                localStorage.removeItem('sparkWallet');
                localStorage.removeItem('generatedSeed');
                localStorage.removeItem('importedSeed');
                localStorage.removeItem('walletReady');
                sessionStorage.clear();
                
                output.textContent = 'All data cleared!\n';
                log('You can now test the wallet generation flow from scratch.');
            }
        }
        
        // Check initial state
        checkAccounts();
    </script>
</body>
</html>